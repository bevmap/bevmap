function bevgeoplot(h,S){function z(){Os=document.getElementById(h).offsetWidth,Ts=document.getElementById(h).offsetHeight}function F(){}function D(){Pn.get('tap').set({threshold:1,posThreshold:1,time:1,interval:2}),Pn.get('press').set({threshold:50,time:3}),Pn.get('pan').set({threshold:sensivity,time:4,direction:Hammer.DIRECTION_ALL}),Pn.get('pinch').set({enable:!0})}function M(co){if(null==co)return console.log('Null object!'),null;for(var uo,ho=0;ho<hl.children.length;ho++)if(hl.children[ho].uuid==co){uo=hl.children[ho];break}return uo}function Q(){line3dtemp.children.length=0,line3dgroup.children.length=0,fallar.children.length=0,Yl.visible=!1,Vl=yp=zp=-1e3,Bn=-1e3,renderblock=1;for(var co=0;co<oman.ao.length;co++)oman.removefromscene(oman.get(co));Cl=[],oman=new V,ea(),allp=new Te,allq=new Ge,ra(),allq.update(),renderblock=0,ee()}function V(){this.ao=Cl,this.history=[],this.sid=Xa,this.so=null,this.sp=null,this.selidx=null,this.changelist={},this.updchangelist=function(co){this.changelist[co]=Xa},this.select=function(co,uo){this.so=null,this.sp=null,this.selidx=null;var ho=fe(co,uo);if(ho[3]>Math.sqrt(Ss*Ss+ws*ws)/7)return console.log('Nothing selected'),[null,null];var go=ho[0];return this.selidx=go,this.so=this.get(go),this.so||console.log('No object selected'),this.sp=allp.par[Qe(go)],this.sp||console.log('No property selected'),Zl.visible=!!this.so,[this.so,this.sp]},this.get=function(co){var uo=this.ao[co];return null==uo?(console.log('No object ',co),null):uo},this.add=function(co){this.ao.push(co)},this.undo=function(){var co=this.history.pop();return co?void('add'==co[0]&&(this.removefromscene(co[1]),this.history.pop()),'remove'==co[0]&&(this.plot(co[1]),this.history.pop()),'removeSequence'==co[0]&&(this.plot(co[1]),this.history.pop(),'removeSequence'==this.history[this.history.length-1][0]&&this.undo()),'movefrom'==co[0]&&this.move(co[1],co[2],co[3]),ra(),ee()):void console.log('No history elements')},this.move=function(co,uo,ho){if(null==co)return void console.log('Trying to move null object');var go=M(co.id);if(go){var mo=uo-co.xs,yo=ho-co.ys;go.position.x+=mo,go.position.y+=yo,params.movestart||this.history.push(['movefrom',co,co.xs,co.ys]),co.xs=uo,co.ys=ho,Zl.visible=!0,Zl.position.set(uo,ho,10),this.updchangelist(co.sid)}},this.erasefromhistory=function(co){for(var uo=0;uo<this.history.length;uo)this.history[uo][1].sameas(co)?this.history.splice(uo,1):uo++},this.removefromscene=function(co,uo){if(1==co.skip)return!1;if('L'==co.type)return co.skip=1,uo?this.history.push(['removeSequence',co]):this.history.push(['remove',co]),renderblock||this.updchangelist(co.sid),!0;var ho=M(co.id);return null==ho?(console.log('No such object on scene',co),!1):(hl.remove(ho),this.history.push(['remove',co]),ee(),co.skip=1,renderblock||this.updchangelist(co.sid),!0)},this.isdublicate=function(co){for(var ho,uo=0;uo<this.ao.length;uo++)ho=this.get(uo),ho.sameas(co)&&(this.removefromscene(ho),this.erasefromhistory(co))},this.plot=function(co){if('L'==co.type)return co.skip=0,void this.history.push(['add',co]);var uo;'W'==co.type&&(uo=_(co.xs,co.ys,co.zs,co.size)),'F'==co.type&&(uo=$(co.xs,co.ys,co.zs,co.angle,co.fall,co.size)),'T'==co.type&&(uo=H(co.text,co.xs,co.ys,co.zs,1- -co.fall)),'B'==co.type&&(uo=B(co.xs,co.ys,co.zs,co.xs,co.ys,co.zs),Nl=uo);uo&&(uo.name=Cl.length,co.id=uo.uuid,co.skip=0,this.history.push(['add',co]),hl.add(uo),ee())}}function R(co){!0==controls.enableRotate||((!params.move||'Line'==params.linetype)&&(On=co.center.x-Gs,lasty=co.center.y-Es),yl.x=2*((co.center.x-Gs)/Os)-1,yl.y=2*-((co.center.y-Es)/Ts)+1,il?C():J())}function C(){fcp=1,gl.setFromCamera(yl,camera);var co=gl.intersectObjects(meshes.children);if(0<co.length){var uo=new ya;uo.sid=Xa;var ho=mr(Vl),go=mr(yp),mo=mr(zp),yo=mr(jl),fo=mr(yp2d),vo=mr(co[0].point.x),xo=mr(co[0].point.y),bo=mr(co[0].point.z),wo=mr(2*(co[0].uv.x-0.5)*ws),So=mr(2*(co[0].uv.y-0.5)*Ss);if(-1e3<Vl){var ko=params.lineStyle==qa.lineStylear[0]?0:params.lineStyle==qa.lineStylear[1]?1:params.lineStyle==qa.lineStylear[2]?2:3,zo=ko+params.color,qo=A(ho,go,mo,vo,xo,bo,Math.round(40*params.size),params.color);if(2==co.length){var Fo=mr(2*(co[1].uv.x-0.5)*ws),Do=mr(2*(co[1].uv.y-0.5)*Ss),Mo={xs:Fo,ys:Do,v:new THREE.Vector3(co[1].point.x,co[1].point.y,co[1].point.z)};linez.push(Mo)}var Mo={xs:yo,ys:fo,v:new THREE.Vector3(ho,go,mo)};linez.push(Mo),line3dtemp.add(qo)}Vl=vo,yp=xo,zp=bo,jl=wo,yp2d=So,zp2d=bo}ee()}function J(){fcp=1,gl.setFromCamera(yl,camera);var co=gl.intersectObjects(Rl);if(0<co.length){var uo=new ya;uo.sid=Xa;var ho=mr(Vl),go=mr(yp),mo=mr(zp),yo=mr(co[0].point.x),fo=mr(co[0].point.y),vo=mr(co[0].point.z);if(!il&&yo<-ws)return je(fo),params.linetype='Select',Re(),void ee();if('Line'==params.linetype){if(-1e3<Vl){Yl.visible=!0,Yl.position.set(yo,fo,10);var xo=params.lineStyle==qa.lineStylear[0]?0:params.lineStyle==qa.lineStylear[1]?1:params.lineStyle==qa.lineStylear[2]?2:3,bo=xo+params.color,wo=A(ho,go,mo,yo,fo,vo+params.layer+1,Math.round(30*params.size),params.color);wo.name=Cl.length,uo.addline(ho,go,mo,yo,fo,vo+params.layer+1,Math.round(30*params.size),bo),oman.plot(uo),oman.add(uo),es.add(wo),Bn=yo,endy=fo}else Tn=yo,firsty=fo,firstz=vo;Yl.visible=!0,Yl.position.set(yo,fo,10),Vl=yo,yp=fo,zp=vo+params.layer+1}if('Bolt'==params.linetype)if(!wl)uo.addbolt(yo,fo,vo+7,yo,fo,vo+7,params.bolttype),oman.plot(uo),oman.add(uo);else{I(yo,fo,vo+7);var So=oman.get(Cl.length-1);So.xe=Pl.vertices[1].x,So.ye=Pl.vertices[1].y,So.ze=Pl.vertices[1].z}if('Fall'==params.linetype&&(Sl?0!=params.fall&&Ma(yo,fo,vo+7):(uo.addfall(yo,fo,vo+7,params.angle,params.fall,Ka<Ya),oman.plot(uo),oman.add(uo))),'Water'==params.linetype&&(uo.addwater(yo,fo,vo+7,Math.round(10*params.size)/10),oman.plot(uo),oman.add(uo)),'Text'==params.linetype&&(uo.addtext(params.text,yo,fo,vo+params.layer+1),oman.plot(uo),oman.add(uo)),'Select'==params.linetype)if(!params.move){oman.select(yo,fo);var ko=fe(yo,fo);if(ko[3]>Math.sqrt(Ss*Ss+ws*ws)/7)return;Zl.visible=!0,Zl.position.set(ko[1],ko[2],10),ms=ko[0],Me(ms)}else if(oman.so){var zo=yo-0.1*ws/camera.zoom,qo=fo+0.1*Ss/camera.zoom;oman.move(oman.get(ms),zo,qo)}}else'Select'==params.linetype?params.move&&re():(Fa(),Zl.visible=!1);ee()}function L(){if(-1e3<Bn){var co=new ya;co.sid=Xa;var uo=params.lineStyle==qa.lineStylear[0]?0:params.lineStyle==qa.lineStylear[1]?1:params.lineStyle==qa.lineStylear[2]?2:3;if(0<uo)return void(Bn=endy=Tn=firsty=firstz=-1e3);var ho=uo+params.color;co.addline(Bn,endy,firstz+params.layer+1,Tn,firsty,firstz+params.layer+1,Math.round(30*params.size),ho),oman.plot(co),oman.add(co),Bn=endy=Tn=firsty=firstz=-1e3,ra(),ee()}}function P(co,uo,ho){hl.remove(ls);var go=6,mo=0.1*Ds;ls=new THREE.Object3D;var yo=-Ss,fo=Ss,vo=A(1.13*ws,yo,0,1.13*ws,fo,0,10,Oa);ls.add(vo);var xo={val:15},bo=H(co,1.13*ws+0.11*ws,yo+mo,0,0,Oa);ls.add(bo);var wo=A(1.13*ws,yo,0,1.067*ws,yo,0,go,Oa);ls.add(wo);var So=A(1.13*-ws,yo,10,1.067*-ws,yo,10,go,Oa);ls.add(So);var ko=H(uo,1.13*ws+0.11*ws,fo-mo,0,0,Oa);ls.add(ko);var zo=A(1.13*ws,fo,0,1.067*ws,fo,0,go,Oa),qo=A(1.13*-ws,fo,10,1.067*-ws,fo,10,go,Oa);ls.add(zo),ls.add(qo);for(var Fo=1;Fo<pmult*(uo-co)/5;++Fo){var Do=-Ss+5*(pmult*Fo*(fo-yo))/(uo-co),Mo=A(1.13*ws,Do,0,1.067*ws,Do,0,go,Oa),Qo=A(1.13*-ws,Do,10,1.067*-ws,Do,10,go,Oa),Vo=5*pmult*Fo+parseInt(co),jo=H(Vo,1.13*ws+0.11*ws,Do,0,0,Oa);ls.add(Mo),ls.add(jo),ls.add(Qo)}var Ro=normPel(co,uo);if(100<Ro[1]-Ro[0])for(var Fo=Ro[0]-1;Fo<=Ro[1];Fo++)if(0==Fo%100){fcp=1;var Co=H(Fo,4*ws,fa(Fo),xo,0,Oa);ls.add(Co),fcp=0}if(null!=ho){ls.position.set(0,ho,0)}hl.add(ls)}function O(co,uo){var ho=normPel(co,uo),go=ho[0],mo=ho[1];if(hl.remove(ss),!!params.rutenett){ss=new THREE.Object3D;for(var So,wo=go;wo<=mo;wo++)So=A(-ws,fa(wo),1,1.13*ws,fa(wo),1,-4,Oa),ss.add(So);hl.add(ss)}}function B(co,uo,ho,go,mo,yo){var fo=new THREE.Object3D,vo=0.07,xo=A(co+vo,uo+vo,ho,co-vo,uo-vo,ho-0.01,2,'#000000'),bo=A(co-vo,uo+vo,ho,co+vo,uo-vo,ho-0.01,2,'#000000'),wo=Qa(co,uo,ho,2*(vo/Math.sqrt(2)),2,'#000000');return Al=G(co,uo,ho,go,mo,yo,4,'#000000'),fo.add(xo),fo.add(bo),fo.add(wo),fo.add(Al),fo}function E(){return 1/2e3}function G(co,uo,ho,go,mo,yo,fo,vo){Pl=new THREE.Geometry,Ol=new THREE.Vector3(co,uo,ho),Pl.vertices.push(Ol),Pl.vertices.push(new THREE.Vector3(go,mo,yo));var xo=new MeshLineMaterial({color:new THREE.Color(vo),lineWidth:fo*E(),useMap:!1,resolution:Bs,sizeAttenuation:!0,near:camera.zoom,far:camera.zoom}),bo=new MeshLine;bo.setGeometry(Pl);var wo=new THREE.Mesh(bo.geometry,xo);return wo}function I(co,uo,ho){var go=(Ol.x-co)*(Ol.x-co)+(Ol.y-uo)*(Ol.y-uo),mo=2*($a/bs),yo=params.boltlen;if(go=Math.sqrt(go)/mo,go<yo)Nl.remove(Al),Al=G(Ol.x,Ol.y,Ol.z,co,uo,ho,4,'#000000'),Nl.add(Al);else{var vo,xo;vo=Ol.x+(co-Ol.x)/go*yo,xo=Ol.y+(uo-Ol.y)/go*yo,Nl.remove(Al),Al=G(Ol.x,Ol.y,Ol.z,vo,xo,ho,4,'#000000'),Nl.add(Al)}}function N(co,uo,ho,go){if(0!=co.length){var mo=new THREE.LineGeometry;mo.setPositions(co);var yo=ho+'',fo=0;7<yo.length&&(fo=yo[0],yo=yo.slice(1,8));var vo=il?5:3,xo=new THREE.LineMaterial({color:new THREE.Color(yo),linewidth:uo/3}),bo=renderer.getSize();xo.resolution.set(bo.width,bo.height);var wo=new THREE.Line2(mo,xo);return null==go&&as.add(wo),wo}}function A(co,uo,ho,go,mo,yo,fo,vo){var xo=new Float32Array(6);xo[0]=co,xo[1]=uo,xo[2]=ho,xo[3]=go,xo[4]=mo,xo[5]=yo;var bo=N(xo,fo,vo,1);return bo}function U(co,uo){var ho=new THREE.Sprite;return ho.position.set(co,uo,2),ho.scale.set(0.4,0.4,0.4),ho}function _(co,uo,ho,go){var mo=new THREE.Sprite(In);return mo.position.set(co,uo,ho),mo.scale.x=mo.scale.y=go*Ds,mo}function H(co,uo,ho,go,mo,yo){var fo=10,vo=new THREE.Object3D,xo=Va(co,yo,go);if(xo.position.set(uo+0.1,ho-0.05,fo/5),vo.add(xo),mo){xo.position.set(uo+0.75,ho-0.2,fo/5);var bo=0.07,wo=A(-bo,-bo,10,bo,bo,10,fo/5,'#000000'),So=A(bo,-bo,10,-bo,bo,10,fo/5,'#000000');wo.position.set(uo,ho,0),So.position.set(uo,ho,0);var ko=U(uo+0.35,ho+0.12);ko.visible=!1,vo.add(wo),vo.add(So),vo.add(ko),2==mo&&(ko.material=Xn,ko.visible=!0,console.log('photo added')),3==mo&&(ko.material=Hn,ko.visible=!0,console.log('labtest added'))}return vo}function X(co){var uo=new FileReader;uo.onloadend=function(ho){var go=Ka;De()&&(go=Math.round(va(Cl[ms].ys)));var mo=new Date,yo='';yo='pic_'+go+'_'+mo.getMinutes()+'m'+mo.getSeconds()+'s',Kn(ho.target.result,yo+'.jpg'),Y(ms,yo,1),Zs.updateDisplay()},uo.readAsDataURL(co.files[0])}function Y(co,uo,ho){var go=Cl[co];if('T'!=De(co))return void console.log('not T');var mo=hl.getObjectByName(co);mo.children[0].material.map.text=''+uo,go.text=uo,oman.updchangelist(go.sid),null!=ho&&(1==ho&&(go.fall=1,mo.children[3].material=Xn),2==ho&&(go.fall=2,mo.children[3].material=Hn),mo.children[3].visible=1),ee()}function Z(co,uo,ho){var go=Cl[co];if('F'!=De(co))return void console.log('not F');var mo=go.size&&Ka<Ya?ho:360-ho,yo=hl.getObjectByName(co);0!=uo&&90!=uo&&(yo.children[1].children[0].material.map.text=''+uo),yo.children[0].material.rotation=Math.round(1e3*(-Math.PI/180*mo))/1e3,0==uo&&(yo.children[0].material.map=Wn,yo.children[1].children[0].material.map.text='',yo.children[0].material.rotation=0),90==uo&&(yo.children[0].material.map=An,yo.children[1].children[0].material.map.text=''),0!=uo&&90!=uo&&(yo.children[0].material.map=Nn),go.fall=parseInt(uo),go.angle=parseInt(ho),oman.updchangelist(go.sid),ee()}function $(co,uo,ho,go,mo,yo){var fo=yo==Ka<Ya?go:360-go,vo='',xo=new THREE.Object3D;if(0!=mo&&90!=mo){Tl=new THREE.SpriteMaterial({map:Nn,color:16777215,rotation:-Math.PI/180*fo});var bo=new THREE.Sprite(Tl);vo=mo+''}if(0==mo)var wo=new THREE.SpriteMaterial({map:Wn,color:16777215}),bo=new THREE.Sprite(wo);if(90==mo){Tl=new THREE.SpriteMaterial({map:An,color:16777215,rotation:-Math.PI/180*fo});var bo=new THREE.Sprite(Tl)}bo.position.set(co,uo,ho),bo.scale.x=bo.scale.y=0.4*Ds;var So=H(vo,co+0.25*Fs,uo-0.12*Ds,ho,0);return xo.add(bo),xo.add(So),xo}function ee(co,uo){if(mt.start('render'),!renderblock){if(null==co&&controls.update(),il?renderer.render(Hl,camera):null==uo?renderer.render(hl,camera):renderer.render(uo,camera),null==co&&(1==rendebug&&console.log('r'),2==rendebug)){var ho=ee.caller;console.log(ho)}var go=mt.end('render');'vlad_adm'==params.author&&(globgeo='Render '+go+'ms',lastgeo.innerHTML=globgeo)}}function ae(co,uo){var ho=Sa();if(!ho)return void console.log('Nothing to save');var go=JSON.stringify(ho),mo=getpelrange(go,picparams.ps,picparams.pe);params.textsave=go,Zs.updateDisplay();var yo=new Date,fo='',vo=getauthorandsid(ho);fo='pel'+mo[0]+'_'+mo[1]+'\''+params.tunnel+'\''+vo.author+shortsid(vo.sid)+'.txt',ifadm()||null!=co||pt(go,fo);var xo={name:fo,size:go.length,content:go},bo=elemfromfile(xo),wo=function(qo){dbputreg(qo,function(){null==uo&&(newdb.ldb(),allq.update())})};console.log('Attempt to add new file to db',bo);var So=newdb.comparef(bo);if(So){console.log('File already exists in db',So);var ko=bo.savedata,zo=So.savedata;comparesave(ko,zo)?console.log('Files are same, not saving'):(console.log('Adding because files are different'),wo(bo))}else console.log('Adding new file to db',bo),wo(bo);le(co)}function le(co){var uo=Sa(1);if(!uo)return void console.log('Nothing to save');var ho=JSON.stringify(uo),go=getpelrange(ho,picparams.ps,picparams.pe);params.textsave=ho,Zs.updateDisplay();var mo=new Date,yo='',fo=getauthorandsid(uo);yo='pel'+go[0]+'_'+go[1]+'\''+params.tunnel+'\''+fo.author+shortsid(fo.sid)+'.txt',ifadm()||null!=co||pt(ho,yo);({name:yo,size:ho.length,content:ho});null==co&&download(ho,yo)}function oe(co,uo){params.withbg||($l.visible=!1),Ke();var ho=new THREE.Scene;ho.add(us),ee(null,ho),console.log('start save as image'),ie(function(go){hl.add(us),ee(),ie(co,go),$l.visible=!0,lt(),ra(),ee(),null!=uo&&(params.what2plot='Geo+Q+Pel')},1)}function ie(co,uo){var ho,mo=window.devicePixelRatio;try{ho=renderer.domElement.toDataURL('image/png');var fo=new Image,vo='For 3d'==params.what2plot?1:0,xo='Only texture'==params.what2plot?1:0;fo.onload=function(){var wo=document.createElement('canvas');wo.width=xo?2*dl:rl,wo.height=xo?2*dl:dl,wo.width*=mo,wo.height*=mo,wo.visible=0;var So=wo.getContext('2d');So.drawImage(fo,0,0);var ko=So.getImageData(0,0,wo.width,wo.height),zo=ko.data,qo=zo.length,Fo=[];if(null!=uo&&!Array.isArray(uo))for(var Do=0;Do<qo;Do+=4)if(208==zo[Do]&&208==zo[Do+1]&&208==zo[Do+2]);else Fo.push(Do);if(null!=uo&&!Array.isArray(uo))return void co(Fo);if(!params.withbg){for(var Do=0;Do<qo;Do+=4)208==zo[Do]&&208==zo[Do+1]&&208==zo[Do+2]&&(zo[Do+3]=0);if(Array.isArray(uo))for(var Do=0;Do<uo.length;Do++)zo[uo[Do]+3]=100}console.log('done pic'),ko.data=zo,So.putImageData(ko,0,0);var Mo=document.createElement('canvas');Mo.visible=0;var Qo=So.getImageData(dl,0,dl+rl,dl);Mo.width=dl,Mo.height=rl;var Vo=Mo.getContext('2d');if(Vo.putImageData(Qo,0,0),ho=xo?Mo.toDataURL():wo.toDataURL(),Ua=ho,console.log('tmp pic saved'),void 0!==co)return Ga=ho,void co();if(!vo){var jo=new Date,Ro='';Ro=Ro+'geo'+jo.getHours()+'h'+jo.getMinutes()+'m'+jo.getSeconds()+'s.png',Kn(ho,Ro)}},fo.src=ho}catch(wo){return void console.log(wo)}}function re(){if(!vl){var co=De();co&&('L'==co?myask(container,'Remove line?',function(){de(),Bn=-1e3,ra(),ee()}):(de(),ra(),ee()))}}function de(){if(oman.so){allp.remove(oman.sp);var co=[];if(co=ue(oman.selidx),'Group'==Ls.value&&1<co.length)for(var uo=0;uo<co.length;uo++)oman.removefromscene(oman.get(co[uo]),1);else oman.removefromscene(oman.so);Zl.visible=!1,oman.so=null,oman.selidx=null}}function ue(co){for(var uo=[co],ho=co-1;0<=ho&&1!=Cl[ho].skip&&Cl[ho].xe==Cl[ho+1].xs&&Cl[ho].ye==Cl[ho+1].ys;ho--)uo.push(ho);for(var ho=co+1;ho<Cl.length&&1!=Cl[ho].skip&&Cl[ho-1].xe==Cl[ho].xs&&Cl[ho-1].ye==Cl[ho].ys;ho++)uo.push(ho);return uo.sort((go,mo)=>go-mo),uo}function he(co){var uo=[];if(-1==co[0])return uo;for(var go,ho=0;ho<co.length;ho++)go=co[ho],0==ho&&(uo.push(Cl[go].xs),uo.push(Cl[go].ys)),uo.push(Cl[go].xe),uo.push(Cl[go].ye);return uo}function ge(){oman.undo(),ra()}function me(){this.tunnel='',this.zeropel=0,this.pelperunit=1,this.pelstart=0,this.pelend=20,this.qval={},this.pval={},this.pw=ws,this.author='V',this.sid=Xa,this.lastchange=0,this.objdata=[]}function fe(co,uo){for(var ho=Cl.length,go=1e3,mo=-1,yo=-20,fo=-20,vo=1,xo=0;xo<ho;xo++)if(!Cl[xo].skip){vo=1;var bo=Cl[xo].xs,wo=Cl[xo].ys,So=(co-bo)*(co-bo)+(uo-wo)*(uo-wo);if('L'==Cl[xo].type){var ko=be(Cl[xo],co,uo);So=ko[0],bo=ko[2],wo=ko[3],(0>ko[1]||1<ko[1])&&(vo=0)}go>=So&&vo&&(go=So,mo=xo,yo=bo,fo=wo)}return[mo,yo,fo,Math.sqrt(go)]}function be(co,uo,ho){var go=co.xs,mo=co.xe,yo=co.ys,fo=co.ye,vo=Math.sqrt((mo-go)*(mo-go)+(fo-yo)*(fo-yo)),wo=[0,1,2,3,4],ko=((mo-go)*(uo-go)+(fo-yo)*(ho-yo))/vo/vo,zo=go+ko*vo*((mo-go)/vo),qo=yo+ko*vo*((fo-yo)/vo),Fo=Math.sqrt((uo-go)*(uo-go)+(ho-yo)*(ho-yo)),Do=Math.sqrt((uo-mo)*(uo-mo)+(ho-fo)*(ho-fo)),Mo=Math.sqrt((uo-zo)*(uo-zo)+(ho-qo)*(ho-qo));return wo[0]=Math.sqrt((uo-zo)*(uo-zo)+(ho-qo)*(ho-qo)),we(ko)||(wo[0]=Math.min(Fo,Do)),wo[1]=ko,wo[2]=zo,wo[3]=qo,wo[4]=0,0>=(mo-go)*(ho-yo)-(fo-yo)*(uo-go)&&(wo[4]=1),wo}function we(co){return 0<=co&&1>=co}function Se(){localStorage.setItem('lastauthor',params.author)}function qe(co,uo){if(Zs.add(params,'dummy').name('Geology:').onChange(function(){Ce()}),ln=Zs.addFolder('Save/Open file'),ln.add(params,'dummy').name(''),ln.add(hn,'showdb').name('ShowDB'),ln.add(params,'dummy').name(''),ln.add(params,'loadprev').name(qa.restoresession),ln.add(params,'savealpha').name(qa.savepicture),ln.add(params,'author').name(qa.author).onChange(function(){Se()}),ln.add(params,'save').name(qa.savegeology),ifadm()&&ln.add(params,'savexml').name('Export to NovaPoint'),ln.add(params,'dummy').name(''),ln.add(params,'openfile').name(qa.openfilegeology),ln.add(params,'overridepel').name('Override pel:'),ln.add(params,'withbg').name(qa.showmwd).onChange(function(){Ut()}),ln.add(params,'showbergart').name(qa.showrocktype).onChange(function(){allp.update(),ee()}),ln.add(params,'forcesync').name('ForcedSync'),null!=co){if(co==qa.qval){nn=Zs.addFolder(qa.qval);var ho=sid2txtdate(Sn.lastchange)+' '+Sn.author;return nn.add(params,'dummy').name(ho),nn.add(Sn,'ps').name('Pel start'),nn.add(Sn,'pe').name('Pel end'),nn.add(Sn,'comment').name(qa.commentary).onChange(function(){Je()}),nn.add(params,'qedit').name(qa.edit),cn.rqd=nn.add(params,'editrqd'),cn.rqd.name('RQD'),cn.Jn=nn.add(params,'editjn'),cn.Jn.name('Jn'),cn.Jr=nn.add(params,'editjr'),cn.Jr.name('Jr'),cn.Ja=nn.add(params,'editja'),cn.Ja.name('Ja'),cn.Jw=nn.add(params,'editjw'),cn.Jw.name('Jw'),cn.SRF=nn.add(params,'editsrf'),cn.SRF.name('SRF'),nn.add(Sn,'Q').onChange(function(){Sn.getQ(),Zs.updateDisplay(),rn.close()}),nn.add(Sn,'class').name(qa.class).onChange(function(){Sn.getQ(),Zs.updateDisplay(),rn.close()}),nn.add(Sn,'bergart',Ks).name(qa.rocktype),nn.add(params,'apply').name(qa.apply),void nn.add(params,'removeq').name(qa.removeq)}if('Select'==co){dn=Zs.addFolder(qa.setproperties);var ho=sid2txtdate(kn.sid)+' '+kn.author;return dn.add(params,'dummy').name(ho),dn.add(kn,'author').name(qa.author),'T'!=uo&&dn.add(kn,'comment').name(qa.commentary),'T'==uo&&(dn.add(Cl[ms],'text').name(qa.text).onChange(function(){Y(ms,Cl[ms].text)}),dn.add(params,'openfoto').name(qa.takephoto),dn.add(params,'makelab').name(qa.labtest)),(null==uo||'L'==uo)&&(dn.add(kn,'bergart',Ks).name(qa.rocktype).listen().onChange(function(){params.parcolor=Fe(kn.bergart),Zs.updateDisplay()}),dn.addColor(params,'parcolor').name(qa.color).listen().onChange(function(){params.parcolor=Fe(kn.bergart),Zs.updateDisplay()})),'W'==uo&&(dn.add(kn,'dsc',qa.dsc).name(qa.description),dn.add(kn,'wdrip').name(qa.dripmin),dn.add(kn,'wleak').name(qa.litmin)),'F'==uo&&(dn.add(Cl[ms],'angle',0,360).step(1).name(qa.angle).onChange(function(){Z(ms,Cl[ms].fall,Cl[ms].angle)}),dn.add(Cl[ms],'fall',0,90).step(1).name(qa.fall).onChange(function(){Z(ms,Cl[ms].fall,Cl[ms].angle)})),dn.add(params,'dummy').name(''),void dn.add(params,'applyP').name(qa.ap)}}rn=Zs.addFolder(qa.main),rn.add(params,'bolt').name(qa.bolt),rn.add(params,'dummy').name(''),rn.add(params,'clear').name(qa.clearall),rn.add(params,'dummy').name(''),rn.add(params,'resetcam').name(qa.resetcamera),rn.add(params,'dummy').name('')}function Fe(co){for(var uo=0;uo<Ks.length;uo++)if(co==Ks[uo])return Ys[uo]}function De(co){var uo=0,ho=ms;null!=co&&(ho=co);hl.getObjectByName(ho);return null==Cl[ho]?uo:1==Cl[ho].skip?uo:Cl[ho].type}function Me(co){var uo=Qe(co);if(-3==uo)return void console.log('Nothing selected');var ho=De(co);chosenp=uo,-2==chosenp?(kn=new Oe,kn.type=ho,kn.coords=Fl,kn.isarea=Be(Fl)):kn.restore(allp.par[chosenp]),ia('Select',ho),Zs.updateDisplay()}function Qe(co){var uo=De(co);if(!uo)return console.log('Nothing selected'),-3;if('L'==uo){var ho=ue(co);Fl=he(ho),0==Fl.length&&console.log('No lines selected')}else Fl=[Cl[co].xs,Cl[co].ys];return allp.get(Fl)}function Ve(co){for(var uo=normPel(Ka,Ya),ho=uo[0];ho<uo[1];ho+=5)if(co>=ho&&co<ho+5){var go=allq.get(ho),mo=allq.get(ho+5);if(-2==go&&-2==mo)return console.log('No Q near'),[ho,ho+5];var yo=ho,fo=-2==mo?go:mo;yo=-2==mo?Math.max(allq.qar[go].ps,allq.qar[go].pe):Math.min(allq.qar[mo].ps,allq.qar[mo].pe);var vo=-2==mo?5:-5;return[yo,yo+vo]}return console.log('No q found'),[co,co+5*uo[2]]}function je(co){var uo=va(co);if(zn=allq.get(uo),-2==zn){Sn=new Ie,Sn.getQ();var ho=Ve(uo);Sn.ps=ho[0],Sn.pe=ho[1],Sn.comment=''}else Sn.restore(allq.qar[zn]);ee(),ia(qa.qval),ln.close(),Zs.removeFolder(qa.main),Zs.removeFolder(qa.setproperties),nn.open(),Zl.visible=!0,Zl.position.set(1.2*-ws,0.35*fa(Sn.pe)+0.65*fa(Sn.ps),10),Ca(),Zs.updateDisplay()}function Re(){setTimeout(function(){Zs.open()},200)}function Ce(){Zs.close()}function Je(){-1<zn?(Sn.lastchange=Xa,allq.qar[zn].restore(Sn)):(allq.add(Sn),zn=allq.qar.length-1),oman.updchangelist(Sn.sid),allq.update(),ee()}function Le(){allq.remove(zn),allq.update(),ee(),Sn=new Ie,Ca()}function Pe(){if(0==Fl.length)return void console.log('No lines selected');if(-1<chosenp){if('undefined'==typeof allp.par[chosenp])return void console.log('No lines selected');allp.par[chosenp].restore(kn),allp.par[chosenp].author=params.author,allp.par[chosenp].lastchange=Xa,'L'==allp.par[chosenp].type&&(allp.par[chosenp].color=xt(Fe(kn.bergart)))}else kn.author=params.author,'L'==kn.type&&(kn.color=xt(Fe(kn.bergart))),kn.sid=Xa,allp.add(kn),chosenp=allp.amtok()-1;oman.sp=allp.par[chosenp],allq.update(),ee()}function Oe(){this.author=params.author,this.sid=Xa,this.lastchange=Xa,this.type='',this.bergart='none',this.ispartofQ=0,this.id='',this.coords=[],this.color=0,this.comment='',this.width=0,this.dsc='Not given',this.wdrip=0,this.wleak=0,this.isarea=!1,this.restore=function(co){var uo=JSON.parse(JSON.stringify(co));this.sid=uo.sid,this.lastchange=null==uo.lastchange?this.sid:uo.lastchange,this.type=uo.type,this.id=uo.id,this.coords=uo.coords,this.bergart=uo.bergart,this.width=uo.width,this.comment=uo.comment,this.ispartofQ=uo.ispartofQ,null!=uo.author&&(this.author=uo.author),this.isarea=uo.isarea,this.color=uo.color,null!=uo.dsc&&(this.dsc=uo.dsc,this.wdrip=uo.wdrip,this.wleak=uo.wleak)},this.sameas=function(co){if(0==co.length)return!1;for(var uo=0;uo<Math.min(co.length,this.coords.length)&&!(6<uo);uo++){if(20<uo)return console.log('Same',this.coords),!0;if(10<co.length){var ho=ga(co[uo],this.coords[uo]);if(!ho)return!0}if(!ha(co[uo],this.coords[uo]))return!1}return!0},this.showprops=function(){var co;return co='W'==this.type?this.coords+' wdrip='+this.wdrip+' wleak='+this.wleak:this.bergart+' '+this.coords,co}}function Te(){this.par=[],this.getareas=function(){var co=[];for(var uo in this.par){var ho=this.par[uo];ho.isarea&&!ho.ispartofQ&&co.push(ho)}return co},this.amtok=function(){for(var co=0,uo=0;uo<this.par.length;uo++)this.par[uo].ispartofQ||co++;return co},this.add=function(co,uo){var ho=new Oe;ho.restore(co),this.par.push(ho),null==uo&&this.update()},this.remove=function(co,uo){if('object'==typeof co)for(var ho in console.log('Trying to remove',co),this.par){var go=this.par[ho];if(go==co){this.par.splice(ho,1);break}}else-1<co&&this.par.splice(co,1);null==uo&&this.update()},this.cleanFromQ=function(){for(var co=0;co<this.par.length;co++)1==this.par[co].ispartofQ&&(this.remove(co,1),co--)},this.y2pelcoords=function(){for(var co=0;co<this.par.length;co++)for(var uo=0;uo<this.par[co].coords.length;uo+=2)this.par[co].coords[uo+1]=va(this.par[co].coords[uo+1])},this.cleanFromPel=function(){for(var co=0;co<this.par.length;co++)Ja(this.par[co].coords[1])||(console.log('Skipping property',this.par[co]),this.remove(co),co--)},this.get=function(co){for(var uo=0;uo<this.par.length;uo++)if(this.par[uo].sameas(co))return uo;return-2},this.restore=function(co,uo,ho){var go=!1;null!=ho&&(go=ho);for(var yo,mo=0;mo<co.par.length;mo++)(yo=this.ismemberalready(co.par[mo]),null==co.par[mo].sid&&(co.par[mo].sid=oo),null==co.par[mo].author&&(co.par[mo].author=po),!(1==go&&co.par[mo].sid<Xa))&&(1<go&&co.par[mo].sid!=go||(-1<yo?this.par[yo].restore(co.par[mo]):this.add(co.par[mo],uo)));null==uo&&(console.log('Update inside restore'),this.update())},this.ismemberalready=function(co){for(var uo=0;uo<this.par.length;uo++)if(this.par[uo].sameas(co.coords))return uo;return-1},this.update=function(){mt.start('updatePinside');var co=renderblock;if(renderblock=1,ea(),params.showbergart)for(var uo=0;uo<this.par.length;uo++)if(('L'==this.par[uo].type||this.par[uo].ispartofQ)&&(this.par[uo].isarea&&We(this.par[uo].coords,Fe(this.par[uo].bergart),this.par[uo].ispartofQ),''!=this.par[uo].comment)){var go,mo,ho=this.par[uo].coords.length;go=this.par[uo].coords[ho-2],mo=this.par[uo].coords[ho-1];var yo=H('comment!',go,mo,5,1);us.add(yo)}renderblock=co,mt.end('updatePinside')}}function Be(co){var uo=co.length;return uo%2?(console.log('Odd amount of coordinates?'),console.log(co),!1):!(8>uo)&&co[0]==co[uo-2]&&co[1]==co[uo-1]}function Ee(co){var uo=Ka<Ya,ho=allq.get(co);return-1<ho&&(uo=allq.qar[ho].ps>allq.qar[ho].pe?0:uo),Ka<tunborder&&(uo=13730<co&&13915>co||14350<co&&14980>co?0:1),17057<co&&17068>co&&(uo=1),uo}function Ge(){this.qar=[],this.add=function(co){var uo=new Ie;uo.restore(co),this.qar.push(uo)},this.get=function(co){for(var mo,uo=1e3,ho=-2,go=0;go<this.qar.length;go++)mo=uo,(this.qar[go].pe>co&&this.qar[go].ps<co||this.qar[go].ps>co&&this.qar[go].pe<co)&&(uo=Math.min(uo,Math.abs(co-this.qar[go].ps),Math.abs(co-this.qar[go].pe),Math.abs(co-(this.qar[go].pe+this.qar[go].ps)/2)),mo!=uo&&(ho=go));return ho},this.remove=function(co){-1<co&&(console.log('Removed Q'),oman.updchangelist(this.qar[co].sid),this.qar.splice(co,1))},this.removeP=function(co){var uo=this.get(co);-1<uo?this.qar.splice(uo,1):console.log('No such Q with pel'+co)},this.getoverlaps=function(){for(var co=[],uo=0;uo<this.qar.length;uo++){for(var ho=0,go=this.qar[uo],mo=Math.min(go.ps,go.pe),yo=Math.max(go.ps,go.pe),fo=uo+1;fo<this.qar.length;fo++){var vo=this.qar[fo],xo=Math.min(vo.ps,vo.pe),bo=Math.max(vo.ps,vo.pe);if(xo<=yo&&xo>=mo){if(xo==yo)continue;var wo=[xo,Math.min(bo,yo)];co.push(wo),go.Q==vo.Q&&go.comment==vo.comment&&(go.sid>vo.sid?(console.log('Removing overlap',vo),this.remove(fo),fo--):ho=1);continue}if(bo<=yo&&bo>=mo){if(bo==mo)continue;var wo=[Math.max(xo,mo),bo];co.push(wo),go.Q==vo.Q&&go.comment==vo.comment&&(go.sid>vo.sid?(console.log('Removing overlap',vo),this.remove(fo),fo--):ho=1)}}ho&&(console.log('Removing i',go),this.remove(uo),uo--)}return 2<co.length&&console.log('Overlaps',co),co},this.update=function(){mt.start('updateQ'),mt.start('Get Q overlaps'),this.getoverlaps(),mt.end('Get Q overlaps'),$t(),mt.start('Clean Q'),allp.cleanFromQ(),mt.end('Clean Q');for(var co=0;co<this.qar.length;co++)if(Zt(this.qar[co].ps,this.qar[co].pe,this.qar[co].getQ(),this.qar[co].class,this.qar[co].comment),'none'!=this.qar[co].bergart){var uo=new Te,ho=new Oe;ho.ispartofQ=1;var go=fa(this.qar[co].ps),mo=fa(this.qar[co].pe);ho.coords=[-ws,go,-ws,mo,ws,mo,ws,go],ho.bergart=this.qar[co].bergart,ho.isarea=!0,uo.add(ho,1),allp.restore(uo,1)}mt.start('updatePFinal'),allp.update(),mt.end('updatePFinal'),mt.end('updateQ')},this.clear=function(){$t(),this.qar=[]},this.restore=function(co,uo,ho){var go=!1;null!=ho&&(go=ho);for(var mo=0;mo<co.qar.length;mo++)if((null==co.qar[mo].sid&&(co.qar[mo].sid=oo),null==co.qar[mo].author&&(co.qar[mo].author=po),!(1==go&&co.qar[mo].sid<Xa))&&!(1<go&&co.qar[mo].sid!=go)){if(params.onlycurpel&&(!Ja(co.qar[mo].ps)||!Ja(co.qar[mo].pe))){console.log('Q not in limits'+co.qar[mo].ps+' '+co.qar[mo].pe);continue}var yo=this.isequal(co.qar[mo]);-1<yo?this.qar[yo].restore(co.qar[mo]):this.add(co.qar[mo])}null==uo&&this.update()},this.isequal=function(co){for(var uo=0;uo<this.qar.length;uo++)if(this.qar[uo].ps==co.ps&&this.qar[uo].pe==co.pe)return uo;return-1}}function Ie(){this.author=params.author,this.sid=Xa,this.lastchange=Xa,this.ps=Ka,this.pe=Ya,this.RQDc='??',this.Jrc='??',this.Jwc='??',this.Jnc='??',this.Jac='??',this.SRFc='??',this.Jnmult=1,this.RQD=-1,this.Jr=-1,this.Jw=-1,this.Jn=-1,this.Ja=-1,this.SRF=-1,this.Q='??',this.class='??',this.comment='',this.bergart='none',this.getQ=function(){return 0>this.RQD||0>this.Jr||0>this.Jr||0>this.Jn||0>this.Ja||0>this.SRF?this.Q:(this.Q=Math.round(1e3*(Math.max(this.RQD,10)*this.Jr*this.Jw/(this.Jn*this.Ja*this.SRF)))/1e3,0.01<this.Q&&(this.Q=Math.round(100*this.Q)/100),1<this.Q&&(this.Q=Math.round(10*this.Q)/10),this.class='G',0.01<this.Q&&(this.class='F'),0.1<this.Q&&(this.class='E'),1<this.Q&&(this.class='D'),4<this.Q&&(this.class='C'),10<this.Q&&(this.class='A/B'),this.Q)},this.restore=function(co){this.ps=co.ps,this.pe=co.pe,this.comment=co.comment,this.bergart=co.bergart,this.RQDc=co.RQDc,this.Jrc=co.Jrc,this.Jwc=co.Jwc,this.Jnc=co.Jnc,this.Jac=co.Jac,this.SRFc=co.SRFc,this.Jnmultc=1,this.RQD=co.RQD,this.Jr=co.Jr,this.Jw=co.Jw,this.Jn=co.Jn,this.Ja=co.Ja,this.SRF=co.SRF,null!=co.author&&(this.author=co.author),null!=co.sid&&(this.sid=co.sid),this.lastchange=null==co.lastchange?this.sid:co.lastchange,this.getQ()}}function We(co,uo,ho){for(var yo,go=[],mo=0;mo<co.length;mo+=2)yo=new THREE.Vector3(co[mo],co[mo+1],1-0.02*ho),go.push(yo);var vo,xo,bo=new THREE.Geometry,wo=new THREE.MeshBasicMaterial({color:uo,transparent:!0,opacity:0.7});wo.side=THREE.DoubleSide,bo.vertices=go,vo=THREE.ShapeUtils.triangulateShape(go,[]);for(var mo=0;mo<vo.length;mo++)bo.faces.push(new THREE.Face3(vo[mo][0],vo[mo][1],vo[mo][2]));xo=new THREE.Mesh(bo,wo),us.add(xo),ee()}function Ue(co){for(var uo=co.elements,ho=0;ho<uo.length;ho++)uo[ho]=mr(uo[ho]);return uo}function He(co,uo){var ho={x:(co/ws+1)/2,y:(uo/Ss+1)/2};return ho}function Xe(co,uo){var ho=uo.x-co[0].x,go=uo.y-co[0].y,mo=0<(co[1].x-co[0].x)*go-(co[1].y-co[0].y)*ho;return 0<(co[2].x-co[0].x)*go-(co[2].y-co[0].y)*ho!=mo&&0<(co[2].x-co[1].x)*(uo.y-co[1].y)-(co[2].y-co[1].y)*(uo.x-co[1].x)==mo}function Ke(){controls.reset(),controls.target.set(0,0,0),camera.position.set(0,0,Ws),cameraFix.position.set(0,0,Ws),Fa(),Ze(),ra()}function Ze(){var co=window.devicePixelRatio;rl=Na,dl=Aa,camera.left=-ws,camera.right=ws,camera.top=Ss+ks,camera.bottom=-Ss+ks,cameraFix.left=-ws,cameraFix.right=ws,cameraFix.top=Ss+ks,cameraFix.bottom=-Ss+ks,'Geo+Q+Pel'==params.what2plot&&(camera.left=-ws-1.2,camera.right=ws+1,rl*=1.3,lsc=0.5),rl/=co,dl/=co;'For 3d'!=params.what2plot&&4096<dl&&(rl=4096*rl/dl,dl=4096);var ho=rl,go=dl;'For 3d'==params.what2plot,renderer.setSize(ho,go),Bs=new THREE.Vector2(ho,go),'For 3d'==params.what2plot&&(lsc=Math.min(0.5,5e3/go));var mo=android||iOS?4:1;buftext=new THREE.WebGLRenderTarget(4096/mo,16384/mo,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat}),camera.updateProjectionMatrix(),cameraFix.updateProjectionMatrix()}function $e(){if(!il){sensivity=1,D();var co=new mytimer('go3d',10);et(),params.what2plot='For 3d',Ke(),co.start('prep',10),il=!0,renderer.render(hl,cameraFix,buftext),co.start('render',10),lt(),co.start('resize',10),Ft(),co.start('make3d',10),camera.position.set(0,0,1e3),params.what2plot='Geo+Q+Pel',controls.enableRotate=!0,ee(),co.start('rend',10),check3dbox.style.display='',check3dbox.checked=!0,ia('3d'),co.end()}}function et(){if(il){for(sensivity=5,D();0<Hl.children.length;)Hl.remove(Hl.children[0]);buftext.dispose(),hl=Kl,params.resetcam(),controls.enableRotate=!1,il=!1,camera.position.set(0,0,Ws),lsc=1,lt(),ra(),setTimeout(function(){ee()},50),Ls.value='Select',ia('Line'),check3dbox.style.display='none'}}function tt(){Ya+=5*pmult,Ka-=5*pmult,Za=Math.abs(parseInt(Ka)-parseInt(Ya)),Aa=$a*Za,dl=Aa,Ss=Aa/bs,P(Ka,Ya,ks),O(Ka,Ya),Zt(Ka,Ya,-1),at(Wa,fa(Ya-2.5*pmult)),at(Wa,fa(Ka+2.5*pmult)),ee()}function at(co,uo){var ho=new THREE.MeshBasicMaterial({color:16777215}),go=new THREE.PlaneGeometry(5*(2*($a/bs)),2*ws,1,1),mo=new THREE.Mesh(go,ho);mo.position.set(0,uo,0),mo.rotateZ(Math.PI/2),Rl.push(mo),$l.add(mo)}function lt(){z(),Bs=new THREE.Vector2(Os,Ts),Is=Os/Ts,camera.left=-Ns*Is/2,camera.right=Ns*Is/2,camera.top=As/2,camera.bottom=-As/2,camera.updateProjectionMatrix(),renderer.setSize(Os,Ts),ee()}function it(){if(un)return!1;for(var co=0,uo=0;uo<Cl.length;uo++)1!=Cl[0].skip&&(co=1);if(allq.qar.length&&(co=1),!co)return!1;var ho=new Date().getTime(),go=Sa(1),mo=JSON.stringify(go);localStorage.setItem(Jl.s,mo);var yo=new Date().getTime()-ho;return console.log('dT = '+yo),!0}function rt(){if(localStorage.getItem(Jl.l)){var co=localStorage.getItem(Jl.l),uo=JSON.parse(co);console.log('Sid set to',uo.sid),ua(uo),allq.update(),ra(),ee(),params.restses=0,ia('Line')}}function pt(co,uo){var ho=new FormData;ho.append('data',co),ho.append('fname',uo);try{var go=window.XMLHttpRequest?new XMLHttpRequest:new activeXObject('Microsoft.XMLHTTP');go.open('post',baseaddr+'procfile.php',!0),go.send(ho)}catch(mo){console.log(mo)}}function ut(){var co=new FormData;co.append('data',params.author);try{var uo=window.XMLHttpRequest?new XMLHttpRequest:new activeXObject('Microsoft.XMLHTTP');uo.onreadystatechange=function(){if(4===uo.readyState){var ho=JSON.parse(uo.response);filetable(container,ho,function(go){var mo=pelfromfname(go),yo=mo[0],fo=mo[1];saveifokdist(yo,fo),ht(go)})}},uo.open('post',baseaddr+'getflist.php',!0),uo.send(co)}catch(ho){console.log(ho)}}function ht(co){var uo=new FormData;uo.append('fname',co);try{var ho=window.XMLHttpRequest?new XMLHttpRequest:new activeXObject('Microsoft.XMLHTTP');ho.onreadystatechange=function(){if(4===ho.readyState){if(params.overridepel){var go=pelfromfname(co),mo=getpelrange(ho.response,go[0],go[1]);no=[],Wa='',Ht(mo[0],mo[1])}ua(ho.response),allq.update(),ra(),ee()}},ho.open('post',baseaddr+'gettxt.php',!0),ho.send(uo)}catch(go){console.log(go)}}function gt(co){var uo=basekjor;'Kjorholt'==co&&(uo=basekjor),'Bamle'==co&&(uo=basebamble);var ho=co+picparams.ps+'_'+picparams.pe+'.xml',go=uo+ba(co)+endfile,mo=vkbeautify.xml(go);download(mo,ho)}function ft(){if(params.vederlag){var co=tungeom[params.tunnel].Width,uo=[];for(var ho in co){var go=co[ho][1],mo=co[ho][3],yo=co[ho][5],fo=yo-go;uo.push([co[ho][0],2*((co[ho][2]-go)/fo)-1,2*((co[ho][3]-go)/fo)-1,2*((co[ho][4]-go)/fo)-1])}for(var zo,qo,Fo,Do,fo,vo=normPel(Ka,Ya),xo=vo[0],bo=vo[1],wo=[],So=[],ko=[],Mo=1,ho=xo;ho<bo;ho++){if(fo=Math.max(ho,uo[0][0]),fo=ho,zo=vt(fo,uo),Fo=fa(fo),qo=vt(fo+pmult,uo),Do=fa(fo+1),!zo||!qo){console.log('No vederlag data for pel=',ho),Mo=0;break}wo.push(zo[0]),wo.push(Fo),wo.push(1),So.push(zo[1]),So.push(Fo),So.push(1),ko.push(zo[2]),ko.push(Fo),ko.push(1)}Mo&&(wo.push(qo[0]),wo.push(Do),wo.push(1),So.push(qo[1]),So.push(Do),So.push(1),ko.push(qo[2]),ko.push(Do),ko.push(1)),N(wo,-7,'0#000000'),N(So,-7,'0#000000'),N(ko,-7,'0#000000'),ee()}}function vt(co,uo){for(var ho=uo.length,go=xct=xrt=0,mo=0,yo=0,fo=0;fo<ho-1;fo++)if(co>=uo[fo][0]&&co<uo[fo+1][0]||co<=uo[fo][0]&&co>uo[fo+1][0]){var vo=uo[fo+1][0]-uo[fo][0];0==vo?mo=[uo[fo][1]*ws,uo[fo][2]*ws,uo[fo][3]*ws]:(yo=(co-uo[fo][0])/(uo[fo+1][0]-uo[fo][0]),go=uo[fo][1]+yo*(uo[fo+1][1]-uo[fo][1]),xct=uo[fo][2]+yo*(uo[fo+1][2]-uo[fo][2]),xrt=uo[fo][3]+yo*(uo[fo+1][3]-uo[fo][3]),mo=[go*ws,xct*ws,xrt*ws])}return mo?mo:co<uo[0][0]?[uo[0][1]*ws,uo[0][2]*ws,uo[0][3]*ws]:[uo[ho-1][1]*ws,uo[ho-1][2]*ws,uo[ho-1][3]*ws]}function xt(co,uo){var ho=co;return 7==ho.length?(ho=null==uo?'0x'+ho[5]+ho[6]+ho[3]+ho[4]+ho[1]+ho[2]:'0x'+ho[1]+ho[2]+ho[3]+ho[4]+ho[5]+ho[6],parseInt(ho)):0}function bt(){il?(js.style.display='none',Rs.style.display='none',Cs.style.display='none',Ls.style.display='none',Ps.style.display='none'):(js.style.display='',Rs.style.display='',Cs.style.display='',Ls.style.display='',Ps.style.display='')}function wt(){js.setAttribute('class','geobutton'),Rs.setAttribute('class','geobutton'),Cs.setAttribute('class','geobutton'),Js.setAttribute('class','geobutton'),Ls.setAttribute('class','geobutton')}function kt(co){var uo=[],ho=co.length;for(var go in uo.push(Rt(co[0][0]+1,co)),co)co[go][0]>co[0][0]+1&&co[go][0]<co[ho-1][0]-1&&uo.push(Rt(co[go][0],co));return uo.push(Rt(co[ho-1][0]-1,co)),uo}function zt(co){var uo=tungeom[co].TunProfile,ho=parse3dmod(uo),go=kt(ho),mo=Mt(ho);for(var yo in go)mo.add(qt(go[yo]));var fo=(ho[0][0]+ho[ho.length-1][0])/2,vo=-fa(fo);return[ho,mo]}function qt(co){var uo=[];for(var ho in co.v)uo.push(co.v[ho].x),uo.push(co.v[ho].y),uo.push(co.v[ho].z);var go=new THREE.Object3D,mo=N(uo,10,'0#000000');return go.add(mo),go}function Ft(){p2y=fa;var co=eo,uo=co[0];lingeom=new THREE.Object3D,lingeom.add(eo[1]),lingeom.add(ao);var ho=(uo[0][0]+uo[uo.length-1][0])/2,go=fa(ho),mo=getglobc((Ka+Ya)/2);lingeom.position.set(-mo.x,-mo.y,-mo.z);var yo=jt(uo),fo=yo[0];partlingeom=yo[1];var vo=new THREE.MeshBasicMaterial({map:buftext.texture,transparent:!0,opacity:0.5});for(var xo in vo.side=THREE.DoubleSide,my3dgroup=new THREE.Object3D,meshes=new THREE.Object3D,fo){var bo=new THREE.Mesh(fo[xo][2],vo);bo.castShadow=!1,bo.receiveShadow=!1,meshes.add(bo)}if(meshes.position.set(-mo.x,-mo.y,-mo.z),my3dgroup.add(meshes),Hl=new THREE.Scene,Kl=hl,'Kjorholt'==params.tunnel){var mo=getglobc((Ka+Ya)/2),wo=new THREE.Object3D;wo.add(ul),wo.position.set(-mo.x,-mo.y,-mo.z),my3dgroup.add(wo)}fo[0][2].computeBoundingSphere();var So=fo[0][2].boundingSphere.center,ko=new THREE.Quaternion;ko.setFromUnitVectors(new THREE.Vector3(0,0,1),new THREE.Vector3(0,1,0)),my3dgroup.applyQuaternion(ko);for(var zo,qo,Fo=0;Fo<oman.ao.length;Fo++)if('B'==oman.ao[Fo].type){var Do=He(oman.get(Fo).xs,oman.get(Fo).ys),Mo=va(oman.get(Fo).ys),Qo=new THREE.Vector2(Do.x,Do.y);for(var Vo in fo)if(numintersect(fo[Vo][0],fo[Vo][1],Mo,Mo)){zo=Zn(meshes.children[Vo],Qo);break}var jo=He(oman.get(Fo).xe,oman.get(Fo).ye),Mo=va(oman.get(Fo).ye),Qo=new THREE.Vector2(jo.x,jo.y);for(var Vo in fo)if(numintersect(fo[Vo][0],fo[Vo][1],Mo,Mo)){qo=Zn(meshes.children[Vo],Qo);break}var Ro=qo[0],Co=qo[1],Jo=zo[0],Lo=zo[1],Po=10,Oo=Yn(new THREE.Vector3(Jo.x,Jo.y,Jo.z),new THREE.Vector3(Ro.x+1*(Lo.x*Po),Ro.y+1*(Lo.y*Po),Ro.z+1*(Lo.z*Po)));wo.add(Oo)}my3dgroup.add(lingeom),my3dgroup.add(partlingeom),Hl.add(my3dgroup),Hl.add(fallar),Hl.add(line3dgroup),Hl.add(line3dtemp),controls.enableRotate=!0,ee()}function Mt(co){for(var uo=co[0][1].length,ho=new THREE.Object3D,go=[],mo=co[0][1],yo=[],fo=co[0][0]+1;fo<co[co.length-1][0]-1;fo+=2)yo.push(Rt(fo,co));for(var vo in mo){for(var xo in go=[],yo){var bo=yo[xo],wo=bo.v[vo];go.push(wo.x,wo.y,wo.z)}var vo=N(go,5,'0#000000');ho.add(vo)}return ho}function Vt(co,uo){var ho=[];if(co<uo[0][0])return ul=[co,uo[0][1]],console.log('Not inside pel limits'),console.log(co,uo[0][0]),ul;if(co>uo[uo.length-1][0])return ul=[co,uo[uo.length-1][1]],console.log('Not inside pel limits'),console.log(co,uo[uo.length-1][0]),ul;for(var go=1;go<uo.length;go++)if(co>=uo[go-1][0]&&co<=uo[go][0]){var mo=uo[go-1][0],yo=uo[go][0],fo=(co-mo)/(yo-mo);for(var vo in uo[go][1]){var xo=uo[go][1][vo],bo=uo[go-1][1][vo];ho.push(new THREE.Vector2(xo.x*fo+bo.x*(1-fo),xo.y*fo+bo.y*(1-fo)))}break}return ho.length||console.log('Error! Vout not defined in getcurveatpel'),[co,ho]}function jt(co){for(var bo,uo=Ka,ho=Ya,go=Vt(uo,co),mo=Vt(ho,co),yo=-1,fo=[[0,go]],vo=[],xo=0;xo<co.length;xo++)if((bo=co[xo][0],Math.round(yo)!=Math.round(bo))&&(yo=bo,bo=Math.round(bo),La(bo,uo,ho))){var wo=(bo-uo)/(ho-uo);vo.push([wo,co[xo]])}if(0<pmult)for(var So=0;So<vo.length;So++)fo.push(vo[So]);else for(var So=vo.length-1;-1<So;So--)fo.push(vo[So]);fo.push([1,mo]);for(var ko=new THREE.Object3D,zo=[],qo=[],So=0;So<fo.length-1;So++)for(var Fo=fo[So][1][0],Do=fo[So+1][1][0],Mo=0,xo=Fo;0>(xo-Do)*pmult;xo+=5*pmult){Mo++;var wo=(xo-uo)/(ho-uo);if(qo.push([wo,Vt(xo,co)]),500<Mo)return}qo.push(fo[fo.length-1]);for(var So=1;So<qo.length;So++){var Qo=Rt(qo[So][1][0],co),Vo=Rt(qo[So-1][1][0],co);zo.push([qo[So-1][1][0],qo[So][1][0],Ct(Vo,Qo,qo[So-1][0],qo[So][0])])}return[zo,ko]}function Rt(co,uo){var ho=Vt(co,uo),go=getglobc(co),mo=getglobc(co,1)[1]/180*Math.PI,yo=getglobc(co+0.01),fo=new THREE.Quaternion;null==yo?(yo=getglobc(co).sub(getglobc(co-0.01)).normalize(),yo=yo.normalize(),yo.z=0,fo.setFromUnitVectors(new THREE.Vector3(1,0,0),yo)):(yo=getglobc(co+0.01).sub(go),yo=yo.normalize(),yo.z=0,fo.setFromUnitVectors(new THREE.Vector3(1,0,0),yo)),0.1<Math.abs(fo.y)&&(console.log(co,go,yo),console.log(co,fo));var vo={pel:co,v:[]};for(var xo in ho[1]){var bo=ho[1][xo],wo=Math.sin(mo),So=Math.cos(mo),ko=new THREE.Vector3(0,bo.x,bo.y);ko.applyAxisAngle(new THREE.Vector3(1,0,0),mo),ko.applyQuaternion(fo),ko.add(go),vo.v.push(ko)}return vo}function Ct(co,uo,ho,go){var mo=new THREE.Geometry,yo=0,fo=co.v.length;mo.faceVertexUvs[0]=[];for(var vo=0;vo<fo-1;++vo){var xo=co.v[vo],bo=co.v[vo+1],wo=uo.v[vo],So=uo.v[vo+1],ko=(fo-(vo+1))/(fo-1),zo=(fo-(vo+2))/(fo-1),qo=null==ho?0:ho,Fo=null==go?1:go;mo.vertices.push(new THREE.Vector3(xo.x,xo.y,xo.z)),mo.vertices.push(new THREE.Vector3(bo.x,bo.y,bo.z)),mo.vertices.push(new THREE.Vector3(wo.x,wo.y,wo.z)),mo.vertices.push(new THREE.Vector3(So.x,So.y,So.z)),mo.faces.push(new THREE.Face3(yo+2,yo+1,yo)),mo.faces.push(new THREE.Face3(yo+1,yo+2,yo+3)),mo.faceVertexUvs[0].push([new THREE.Vector2(ko,Fo),new THREE.Vector2(zo,qo),new THREE.Vector2(ko,qo)]),mo.faceVertexUvs[0].push([new THREE.Vector2(zo,qo),new THREE.Vector2(ko,Fo),new THREE.Vector2(zo,Fo)]),yo+=4}return mo.uvsNeedUpdate=!0,mo.computeFaceNormals(),mo}function Jt(){mt.start('Initing model',2),ao=new THREE.Object3D;var co=tun2='';if('34100'==params.tunnel&&(tun2='34100',co='34000'),'34000'==params.tunnel&&(tun2='34000',co='34100'),co){globavg=tungeom[co].Geo3d.globavg,globtc=tungeom[co].Geo3d.globtc,ao=zt(co)[1];var uo=tv().copy(tungeom[co].Geo3d.globavg).sub(tungeom[tun2].Geo3d.globavg);ao.position.set(uo.x,uo.y,uo.z)}if(globavg=tungeom[params.tunnel].Geo3d.globavg,globtc=tungeom[params.tunnel].Geo3d.globtc,eo=zt(params.tunnel),'Kjorholt'==params.tunnel){var ho=new mytimer('Cloud',5);ul=makecloud(),ho.end()}mt.end('Initing model',2)}function Lt(){var co=linez.length;if(!(2>co)){for(var ho,uo=1;uo<co;uo++)ho=new ya,ho.addline(linez[uo-1].xs,linez[uo-1].ys,1,linez[uo].xs,linez[uo].ys,1,Math.round(30*params.size),'#000000'),oman.add(ho);var go=linez[0].v,mo=linez[Math.floor(co/2)].v,yo=linez[co-1].v,fo=Pt();return console.log(fo),console.log('Prev'),console.log([go,mo,yo]),fo}}function Pt(){for(var co=linez.length,uo=Math.floor(co/3),ho=Math.floor(2*co/3),go=tv(),mo=tv(),yo=tv(),fo=0;fo<uo;fo++)go.add(linez[fo].v);go.multiplyScalar(1/uo);for(var fo=uo;fo<ho;fo++)mo.add(linez[fo].v);mo.multiplyScalar(1/(ho-uo));for(var fo=ho;fo<co;fo++)yo.add(linez[fo].v);return yo.multiplyScalar(1/(co-ho)),[go,mo,yo]}function Ot(co){var uo=new THREE.Plane().setFromCoplanarPoints(co[0],co[1],co[2]),ho=new THREE.Vector3((co[0].x+co[1].x+co[2].x)/3,(co[0].y+co[1].y+co[2].y)/3,(co[0].z+co[1].z+co[2].z)/3),go=new THREE.BoxGeometry(150,150,0.5),mo=new THREE.MeshBasicMaterial({color:17408,transparent:!0,opacity:0.1}),yo=new THREE.Mesh(go,mo),fo=new THREE.Quaternion;fo.setFromUnitVectors(new THREE.Vector3(0,0,1),uo.normal),yo.applyQuaternion(fo),yo.position.set(ho.x,ho.y,ho.z),yo.scale.set(fscale.val,fscale.val,1),fallar.add(yo);var vo=uo.normal;0>vo.y&&vo.negate();var xo=180*new THREE.Vector3(0,1,0).angleTo(vo)/Math.PI,bo=va(linez[0].ys),wo=getglobc(bo+1).sub(getglobc(bo));wo=wo.normalize();var So=getglobc((Ka+Ya)/2),ko=new THREE.Quaternion;ko.setFromUnitVectors(new THREE.Vector3(0,0,1),new THREE.Vector3(0,1,0)),wo.applyQuaternion(ko);var zo=new THREE.Quaternion;zo.setFromUnitVectors(new THREE.Vector3(0,1,0).applyQuaternion(ko),new THREE.Vector3(1,0,0).applyQuaternion(ko));var qo=tv().copy(wo).applyQuaternion(zo),Fo=new THREE.Plane().setFromCoplanarPoints(ho,tv().copy(ho).add(qo),tv().copy(ho).add(wo)),Do=tv().copy(vo).projectOnPlane(Fo.normal),Mo=Do.angleTo(wo)<Math.PI/2?1:0,Qo=180*Do.angleTo(qo)/Math.PI;return Qo=Mo?360-Qo:Qo,console.log('Strike:',Qo),console.log('Dip/Fall',xo),[Math.floor(Qo),Math.round(xo)]}function Et(){if(linez.length){var co=new ConvexHullGrahamScan;for(var uo in linez)co.addPoint(linez[uo].xs,linez[uo].ys);var ho=co.getHull();console.log('Before',linez),console.log('After',ho);var go=[];for(var mo in linez)for(var uo in ho){var yo=linez[mo];ho[uo].x==yo.xs&&ho[uo].y==yo.ys&&go.push(yo)}console.log(go),linez=go,linez.sort(function(wo,So){return So.xs-wo.xs});var fo=y=0;for(var mo in linez)fo+=linez[mo].xs,y+=linez[mo].ys;fo/=linez.length,y/=linez.length;var vo=Lt(),xo=Ot(vo),bo=new ya;bo.addfall(fo,y,8,xo[0],xo[1],1),oman.plot(bo),oman.add(bo),Gt(linez),ra(),ee(),linez=[],controls.enableRotate=!0,check3dbox.checked=!0,Zs.updateDisplay()}}function Gt(co){var uo=[];for(var ho in co)uo.push(co[ho].v.x,co[ho].v.y,co[ho].v.z);if(uo.length){var go=N(uo,Math.round(40*params.size),'#000000',1);line3dgroup.add(go)}}function Ut(){params.withbg?_t(Wa):_t(''),Hs.material=Xs,ee()}function _t(co){if(''==co)Xs=new THREE.MeshBasicMaterial({color:16777215});else{var uo=new THREE.TextureLoader;uo.crossOrigin='anonymous';var ho=uo.load(co,function(){ee()});ho.magFilter=THREE.NearestFilter,ho.minFilter=THREE.LinearMipMapLinearFilter,ho.anisotropy=2,Ka>Ya&&(ho.flipY=!1),Xs=new THREE.MeshBasicMaterial({map:ho})}}function Ht(co,uo){Xa=getsessionid(),Q(),Ya=parseInt(uo),Ka=parseInt(co),pmult=Ka<Ya?1:-1,el=(Ka+Ya)/2,Za=Math.abs(parseInt(Ka)-parseInt(Ya)),$a=50,11>Za&&($a=100),6>Za&&($a=200),Aa=$a*Za,dl=Aa,Ss=Aa/bs,P(Ka,Ya,ks),O(Ka,Ya),Yt(Wa,0),Zt(Ka,Ya,-1),params.resetcam(),ee(),picparams.ps=Ka,picparams.pe=Ya,saveifokdist(picparams.ps,picparams.pe),fgui.updateDisplay()}function Xt(co,uo,ho){console.log('in pelfrom pic',picparams.ps,picparams.pe);var go=params.tunnel;null!=ho&&(go=ho);var mo=co>uo,yo=Math.min(co,uo),fo=Math.max(co,uo),vo=25*Math.floor(yo/25);if(0>vo||0>xo)return void console.log('Trying to get negative pels',vo,xo);var xo=25*Math.floor((fo-0.01)/25+1);console.log('Before count',vo,xo);for(var wo,bo=vo;bo<xo;bo+=25)wo=go+bo+'_'+parseInt(bo+25),dbgetpic(wo,function(So){-1!=So&&Kt(So,mo)});Wa='',mo?Ht(xo,vo):Ht(vo,xo),et()}function Kt(co,uo){var ho=Ka>Ya;null!=uo&&(ho=uo);var go=new THREE.TextureLoader;go.crossOrigin='anonymous',null!=co.tunmodel&&(deftm=co.tunmodel);var mo=go.load(co.pic,function(){ee()});mo.magFilter=THREE.NearestFilter,mo.minFilter=THREE.LinearMipMapLinearFilter,mo.anisotropy=2,ho&&(mo.flipY=!1);var yo=new THREE.MeshBasicMaterial({map:mo}),fo=Math.abs(fa(Math.max(co.ps,co.pe))-fa(Math.min(co.ps,co.pe))),vo=fa((co.ps- -co.pe)/2),xo=new THREE.PlaneGeometry(fo,2*ws,1,1);Hs=new THREE.Mesh(xo,yo),Hs.position.set(0,vo,0.01);var bo=ho?Math.PI:0;Hs.rotateZ(Math.PI/2+bo),Rl.push(Hs),$l.add(Hs)}function Yt(co,uo){hl.remove($l),$l=new THREE.Object3D,Rl.length=0,_t(co);var ho=new THREE.PlaneGeometry(2*Ss,2*ws,1,1);Hs=new THREE.Mesh(ho,Xs),Hs.position.set(0,uo/$a,0);var go=Ka>Ya?Math.PI:0;Hs.rotateZ(Math.PI/2+go),Rl.push(Hs),$l.add(Hs),hl.add($l)}function Zt(co,uo,ho,go,mo){var yo,fo=!1;-1==ho?(fo=!0,yo=11184810):(yo=16711680,1<ho&&(yo=16769024),4<ho&&(yo=16746240),10<ho&&(yo=2258722));var vo=fo?1:0.8,xo=new THREE.MeshBasicMaterial({color:yo,transparent:!0,opacity:vo}),bo=fa((co+uo)/2),wo=Math.abs(fa(uo)-fa(co)),So=ws/3,ko=-ws-So+ws/10,zo=new THREE.PlaneGeometry(So,wo,1,1),qo=new THREE.Mesh(zo,xo);if(qo.position.set(ko,bo,fo?0:1),fo){var Fo=ds.children[0];null!=Fo&&ds.remove(Fo),ds.add(qo),Rl.push(qo)}else{is.add(qo);var Do=H('Q='+ho+' '+go,ko,bo,10,0);if(is.add(Do),null!=mo&&''!=mo){for(var Mo='',Qo=0;Qo<Math.min(4,mo.length);Qo++)Mo+=mo[Qo];Mo+='..!';var Vo=H(Mo,ko-0.35*Fs,bo+0.38*wo,10,1);is.add(Vo)}}}function $t(){for(;is.children.length;){var co=is.children[0];'undefined'!=typeof co.material&&co.material.dispose(),'undefined'!=typeof co.geometry&&co.geometry.dispose(),is.remove(co)}}function ea(){for(;us.children.length;){var co=us.children[0];'undefined'!=typeof co.material&&co.material.dispose(),'undefined'!=typeof co.geometry&&co.geometry.dispose(),us.remove(co)}}function oa(){for(;as.children.length;){var co=as.children[0];'undefined'!=typeof co.material&&co.material.dispose(),'undefined'!=typeof co.geometry&&co.geometry.dispose(),as.remove(co)}for(;ns.children.length;){var co=ns.children[0];'undefined'!=typeof co.material&&co.material.dispose(),'undefined'!=typeof co.geometry&&co.geometry.dispose(),ns.remove(co)}for(;es.children.length;){var co=es.children[0];'undefined'!=typeof co.material&&co.material.dispose(),'undefined'!=typeof co.geometry&&co.geometry.dispose(),es.remove(co)}}function ia(co,uo){var ho=co;il&&(ho='3d'),bt(),null==ho&&(Fl=[],chosenp=-2);var go=Zs.closed;return Zs.destroy(),container.removeChild(Zs.domElement),Zs=new dat.GUI({autoPlace:!1,width:Math.min(500,Os/2-4)}),container.appendChild(Zs.domElement),Zs.domElement.id='guipos','3d'==ho?(Zs.add(lingeom,'visible').name('Tunnel frame').onChange(function(){ee()}),'Kjorholt'==params.tunnel&&(Zs.add(pointval,'valmin',1,pointval.ar.length).name('Min').step(1).onChange(function(){pointCloud.geometry.drawRange.start=pointval.ar[pointval.valmin-1],pointCloud.geometry.drawRange.count=pointval.ar[pointval.valmax-1]-pointCloud.geometry.drawRange.start,ee()}),Zs.add(pointval,'valmax',1,pointval.ar.length).name('Max').step(1).onChange(function(){pointCloud.geometry.drawRange.count=pointval.ar[pointval.valmax-1]-pointCloud.geometry.drawRange.start,ee()}),Zs.add(pMaterial,'size',5,35).name('Point size').step(1).onChange(function(){ee()})),Zs.add(params,'opacity',0,1).name('Tunnel opacity').step(0.1).onChange(function(){meshes.children[0].material.opacity=params.opacity,ee()}),Zs.add(fscale,'val',0,1).name('Plane scale').step(0.02).onChange(function(){for(var mo in fallar.children)fallar.children[mo].scale.set(fscale.val,fscale.val,1);ee()}),void Zs.updateDisplay()):void(qe(ho,uo),null==uo&&Fa(),wt(),'Q - value'==ho&&(Zs.updateDisplay(),params.linetype='Q - value',Ls.value='Select'),'Line'==ho&&(js.setAttribute('class','geobuttonf'),params.linetype='Line',rn.add(params,'lineStyle',qa.lineStylear).name(qa.ls),rn.add(params,'size',0.1,1).name('Size').step(0.1),rn.add(params,'dummy').name('')),'Water'==ho&&(Rs.setAttribute('class','geobuttonf'),params.linetype='Water',rn.add(params,'size',0.1,1).step(0.1),rn.add(params,'dummy').name('')),'Text'==ho&&(Cs.setAttribute('class','geobuttonf'),params.linetype='Text',rn.add(params,'text').name(qa.ttp)),'Fall'==ho&&(Js.setAttribute('class','geobuttonf'),params.linetype='Fall',rn.add(params,'angle',0,360).step(1).name(qa.angle),rn.add(params,'fall',0,90).step(1).name(qa.fall),rn.add(params,'dummy').name('')),'Bolt'==ho&&(params.linetype='Bolt',rn.add(params,'boltlen',1,10).step(0.5).name(qa.len),rn.add(params,'bolttype',qa.boltlist).name(qa.material),rn.add(params,'dummy').name('')),'Select'==ho?(Ls.setAttribute('class','geobuttonf'),params.linetype='Select'):rn.open(),Zs.updateDisplay(),go?Ce():Re())}function ra(){oa(),ft();for(var co=[],uo=0;uo<Cl.length;uo++)0==Cl[uo].skip&&co.push(Cl[uo]);for(var mo,yo,ho=yprev=cprev=sprev=-1e3,go=[],uo=0;uo<co.length;uo++)if('L'==co[uo].type)if(ho==co[uo].xs&&yprev==co[uo].ys&&cprev==co[uo].color&&sprev==co[uo].size){var fo=[co[uo].xe,co[uo].ye,co[uo].zs];ho=co[uo].xe,yprev=co[uo].ye,go.push(fo[0]),go.push(fo[1]),go.push(fo[2])}else N(go,yo,mo),ho=co[uo].xe,yprev=co[uo].ye,cprev=co[uo].color,sprev=co[uo].size,go=[co[uo].xs,co[uo].ys,co[uo].zs,ho,yprev,co[uo].zs],mo=co[uo].color,yo=co[uo].size;N(go,yo,mo)}function pa(){this.oldzero=1,this.oldppu=1,this.oldpw=1,this.getnewy=function(co){var ho=fa(co);return ho=mr(ho),ho},this.getnewx=function(co){var uo=co/this.oldpw*ws;return uo=mr(uo),uo}}function ca(co,uo){for(var ho in uo)for(var go=uo[ho],mo=0;mo<go.length;mo++)if(go[mo]==co)return''+ho;return null}function ua(co){mt.start('Get json');var uo='object'==typeof co?JSON.parse(JSON.stringify(co)):JSON.parse(co);var ho=uo.objdata;mt.end('Get json');var go=new pa,mo=uo.authors,yo=uo.sids,fo=uo.chlist;if(null==fo||isEmpty(fo))for(var vo in yo)oman.changelist[vo]=vo;else for(var vo in yo)oman.changelist[vo]=fo[vo];go.oldzero=uo.zeropel,po=uo.author,go.oldppu=uo.pelperunit,go.oldpw=uo.pw,oo=uo.sid,mt.start('q restore'),allq.restore(uo.qval,1),mt.end('q restore');var xo=uo.pval;mt.start('param coord convert');for(var bo=0;bo<xo.par.length;bo++)for(var vo=0;vo<xo.par[bo].coords.length;vo+=2)xo.par[bo].coords[vo]=go.getnewx(xo.par[bo].coords[vo]),xo.par[bo].coords[vo+1]=go.getnewy(xo.par[bo].coords[vo+1],1);mt.end('param coord convert'),mt.start('p restore'),allp.restore(xo,1),mt.end('p restore');var wo=ho.length,So=6,ko='#000000',zo=qy=qz=tmpy=tmpx=-1e3;mt.start('read elems');for(var qo,vo=0;vo<wo;vo++){if(qo=new ya,null==yo)qo.sid=oo;else{var Fo=ca(vo,yo);qo.sid=null==Fo?oo:Fo}if(null==mo)qo.author=po;else{var Fo=ca(vo,mo);qo.author=null==Fo?po:Fo}var Do=ho[vo];if(2==Do.length){tmpx=go.getnewx(Do[0]/qprec),tmpy=go.getnewy(Do[1]/qprec),qo.addline(zo,qy,qz,tmpx,tmpy,qz,So,ko),zo=go.getnewx(Do[0]/qprec),qy=go.getnewy(Do[1]/qprec),oman.isdublicate(qo),oman.plot(qo),oman.add(qo);continue}if(0==Do[0]){So=15,ko='#000000',6<Do.length&&('number'==typeof Do[6]&&(So=Do[6]),'string'==typeof Do[6]&&(ko=Do[6])),8==Do.length&&(ko=Do[7]),zo=go.getnewx(Do[4]/qprec),qy=go.getnewy(Do[5]/qprec),qz=Do[3],tmpx=go.getnewx(Do[1]/qprec),tmpy=go.getnewy(Do[2]/qprec),qo.addline(tmpx,tmpy,qz,zo,qy,qz,So,ko),oman.isdublicate(qo),oman.plot(qo),oman.add(qo);continue}if(1==Do[0]){So=0.5,3<So.length&&(So=Do[3]),tmpx=go.getnewx(Do[1]/qprec),tmpy=go.getnewy(Do[2]/qprec),qo.addwater(tmpx,tmpy,10,So),oman.isdublicate(qo),oman.plot(qo),oman.add(qo);continue}if(2==Do[0]){tmpx=go.getnewx(Do[1]/qprec),tmpy=go.getnewy(Do[2]/qprec);var Mo=Do[4];'_pho_'==Mo.slice(0,5)&&(qo.fall=1,Mo=Mo.slice(5),console.log(Mo)),'_lab_'==Mo.slice(0,5)&&(qo.fall=2,Mo=Mo.slice(5)),qo.addtext(Mo,tmpx,tmpy,Do[3],1),oman.isdublicate(qo),oman.plot(qo),oman.add(qo);continue}if(3==Do[0]&&(tmpx=go.getnewx(Do[1]/qprec),tmpy=go.getnewy(Do[2]/qprec),qo.addfall(tmpx,tmpy,10,Do[3],Do[4],Do[5]),oman.isdublicate(qo),oman.plot(qo),oman.add(qo)),4==Do[0]){qo.addbolt(go.getnewx(Do[1]/qprec),go.getnewy(Do[2]/qprec),Do[3],go.getnewx(Do[4]/qprec),go.getnewy(Do[5]/qprec),Do[6],Do[7]),oman.isdublicate(qo),oman.plot(qo),oman.add(qo);continue}}mt.end('read elems')}function ha(co,uo,ho){var go=0.02/Math.abs(Ka-Ya);null!=ho&&(go=ho);var mo=Math.abs(parseFloat(co)-parseFloat(uo));return!!(mo<go)}function ga(co,uo){var go=Math.abs(parseFloat(co)-parseFloat(uo));return go}function ya(){this.type='',this.sid=Xa,this.author=params.author,this.id=0,this.skip=0,this.text='',this.xs=0,this.ys=0,this.zs=0,this.xe=0,this.ye=1,this.ze=1,this.size=3,this.color='',this.fall=0,this.angle=0,this.lastmx=-1e3,this.lastmy=-1e3,this.sameas=function(co){return this.type==co.type&&ha(this.xs,co.xs)&&ha(this.ys,co.ys)},this.addline=function(co,uo,ho,go,mo,yo,fo,vo){this.type='L',this.size=fo,this.color=vo,this.xs=co,this.ys=uo,this.zs=ho,this.xe=go,this.ye=mo,this.ze=yo},this.addbolt=function(co,uo,ho,go,mo,yo,fo){this.type='B',this.text=fo,this.xs=co,this.ys=uo,this.zs=ho,this.xe=go,this.ye=mo,this.ze=yo},this.addwater=function(co,uo,ho,go,mo,yo,fo,vo){this.type='W',this.size=go,this.xs=co,this.ys=uo,this.zs=ho,null!==mo&&(this.text=mo),null!==yo&&(this.xe=yo),null!==fo&&(this.fall=fo),null!==vo&&(this.angle=vo)},this.addfall=function(co,uo,ho,go,mo,yo){this.type='F',this.xs=co,this.ys=uo,this.zs=ho,this.angle=go,this.fall=mo,this.size=null==yo?Ee(va(uo)):yo},this.addtext=function(co,uo,ho,go){this.type='T',this.text=co,this.xs=uo,this.ys=ho,this.zs=go}}function fa(co){var uo=parseFloat(2*(pmult*(co-parseFloat(el))*$a/bs));return uo}function va(co){var uo=parseFloat(pmult*co/(2*($a/bs))+el);return uo}function xa(){var co=new Date,uo=parseInt(co.getMonth()+1),ho={date:co.getFullYear()+'-'+az(uo)+'-'+az(co.getDate()),author:params.author};return ho}function ba(co){for(var uo=[],ho=[],go={pmult:pmult,pelperunit:1/(2*($a/bs)),zeropel:el,pw:ws,author:params.author,tunnel:co},mo=new myxml(go),yo={type:'w',da:xa(),coords:[0,1],comment:'',dsc:0,drip:'',leak:''},fo={type:'t',da:xa(),coords:[0,1],comment:'',fall:0},vo={type:'f',da:xa(),coords:[0,1],comment:'',angle:0,fall:0},xo={type:'l',da:xa(),coords:[0,1],ltype:0,comment:'',bergart:'none',color:'',width:0},bo={type:'q',da:xa(),coords:[0,1],QVal:[],bergart:'none',color:0,comment:''},wo=0;wo<allq.qar.length;wo++){var So=allq.qar[wo],ko=bo;ko.da.author=So.author,ko.da.date=sid2date(So.lastchange),ko.coords=[So.ps,So.pe],ko.QVal=[So.RQD,So.Jn,So.Jr,So.Ja,So.Jw,So.SRF,So.Q],ko.bergart=So.bergart,ko.comment=So.comment,ko.color=xt(Fe(So.bergart)),mo.parseos(ko)}for(var wo=0;wo<Cl.length;wo++)if(!Cl[wo].skip&&!isinarray(ho,wo)){var zo=Qe(wo);if(!isinarray(uo,zo)){var Do,qo=De(wo),Fo=-2<zo?1:0;Fo&&(uo.push(zo),Do=allp.par[zo]);var Qo,Mo=Cl[wo];if('L'==qo)if(Qo=xo,Qo.da.author=Mo.author,Qo.da.date=sid2date(Mo.sid),Qo.ltype=Mo.color[0],Fo)Do.isarea&&(Qo.ltype=5),Qo.coords=Do.coords,Qo.comment=Do.comment,Qo.bergart=Do.bergart,Qo.color=Do.color,Qo.width=Do.width;else{for(var Vo=ue(wo),jo=0;jo<Vo.length;jo++)ho.push(Vo[jo]);Qo.coords=he(Vo)}'W'==qo&&(Qo=yo,Qo.da.author=Mo.author,Qo.da.date=sid2date(Mo.sid),Qo.coords=[Mo.xs,Mo.ys],Fo&&(Do.comment&&(Qo.comment=Do.comment),Do.dsc&&(Qo.dsc=Do.dsc),Do.wdrip&&(Qo.drip=Do.wdrip),Do.wleak&&(Qo.leak=Do.wleak))),'T'==qo&&(Qo=fo,Qo.da.author=Mo.author,Qo.da.date=sid2date(Mo.sid),Qo.coords=[Mo.xs,Mo.ys],Qo.comment=Mo.text,Qo.fall=Mo.fall),'B'==qo&&(Qo=fo,Qo.da.author=Mo.author,Qo.da.date=sid2date(Mo.sid),Qo.coords=[Mo.xs,Mo.ys],Qo.comment='B'),'F'==qo&&(Qo=vo,Qo.da.author=Mo.author,Qo.da.date=sid2date(Mo.sid),Qo.coords=[Mo.xs,Mo.ys],Qo.angle=Mo.size?Mo.angle:360-Mo.angle,Qo.fall=Mo.fall),mo.parseos(Qo)}}return mo.showstrout()}function wa(co,uo){for(var ho=[],go=[],mo=JSON.parse(JSON.stringify(co)),yo=0;yo<mo.length;yo++)if(!isinarray(go,yo)){var fo=params.onlynew&&!uo?mo[yo].sid==Xa:1;1<params.onlynew&&(fo=mo[yo].sid==params.onlynew?1:0);var vo=1;if(params.onlycurpel&&!uo&&!Ja(va(mo[yo].ys))){var xo=ue(yo);add2array(go,xo),vo=0}!mo[yo].skip&&fo&&vo&&ho.push(mo[yo])}return ho}function Sa(co){var uo=0;null!=co&&(uo=co);var ho=wa(Cl,uo),go=new me;go.lastchange=oman.changelist[params.onlynew],null==go.lastchange&&(go.lastchange=Xa),go.zeropel=el,go.pelperunit=$a*pmult,go.pw=ws,go.pelstart=Ka,go.pelend=Ya,go.author=params.author,go.authors={},go.sid=Xa,go.sids={},go.tunnel=params.tunnel;var mo=new Ge;uo?mo.restore(allq,1):mo.restore(allq,1,params.onlynew),go.qval=mo;var yo=new Te;yo.restore(allp,1,params.onlynew&&!uo),uo?yo.restore(allp,1):yo.restore(allp,1,params.onlynew),yo.cleanFromQ(),yo.y2pelcoords(),params.onlycurpel&&yo.cleanFromPel(),go.pval=yo;for(var fo=yprev=cprev=sprev=-1e3,vo=0;vo<ho.length;vo++)ho[vo].ys=va(ho[vo].ys),ho[vo].ye=va(ho[vo].ye);for(var xo,vo=0;vo<ho.length;vo++){xo=ho[vo].author,null==go.authors[xo]?go.authors[xo]=[vo]:go.authors[xo].push(vo);var bo=ho[vo].sid;if(null==go.sids[bo]?go.sids[bo]=[vo]:go.sids[bo].push(vo),'L'==ho[vo].type){if(fo==Math.round(ho[vo].xs*qprec)&&yprev==Math.round(ho[vo].ys*qprec)&&cprev==ho[vo].color&&sprev==ho[vo].size){var wo=[Math.round(ho[vo].xe*qprec),Math.round(ho[vo].ye*qprec)];fo=Math.round(ho[vo].xe*qprec),yprev=Math.round(ho[vo].ye*qprec)}else{fo=Math.round(ho[vo].xe*qprec),yprev=Math.round(ho[vo].ye*qprec),cprev=ho[vo].color,sprev=ho[vo].size;var wo=[0,Math.round(ho[vo].xs*qprec),Math.round(ho[vo].ys*qprec),ho[vo].zs,fo,yprev];6!=ho[vo].size&&wo.push(ho[vo].size),'#000000'!=ho[vo].color&&wo.push(ho[vo].color)}go.objdata.push(wo)}if('W'==ho[vo].type){fo=-1e3;var wo=[1,ho[vo].xs*qprec,ho[vo].ys*qprec];0.5!=ho[vo].size&&wo.push(ho[vo].size),go.objdata.push(wo)}if('T'==ho[vo].type){fo=-1e3;var So=ho[vo].text;1==ho[vo].fall&&(So='_pho_'+So),2==ho[vo].fall&&(So='_lab_'+So);var wo=[2,ho[vo].xs*qprec,ho[vo].ys*qprec,ho[vo].zs,So];go.objdata.push(wo)}if('F'==ho[vo].type){fo=-1e3;var wo=[3,ho[vo].xs*qprec,ho[vo].ys*qprec,ho[vo].angle,ho[vo].fall,ho[vo].size];go.objdata.push(wo)}if('B'==ho[vo].type){fo=-1e3;var wo=[4,ho[vo].xs*qprec,ho[vo].ys*qprec,ho[vo].zs,ho[vo].xe*qprec,ho[vo].ye*qprec,ho[vo].ze,ho[vo].text];go.objdata.push(wo)}}var ko=Object.keys(go.authors).length;if(1==ko){var zo=ca(0,go.authors);null!=zo&&(go.author=ca(0,go.authors)),null==go.authors}var qo=Object.keys(go.sids).length;if(1==qo){var zo=ca(0,go.sids);null!=zo&&(go.sid=ca(0,go.sids)),null==go.sids}for(var Fo in go.chlist={},go.sids){var xo=oman.changelist[Fo];console.log('Element of changelist',Fo,xo),null!=xo&&(go.chlist[Fo]=xo)}return console.log('Saved change list',go.chlist),0==go.qval.qar.length&&console.log('No Q to save'),0==go.pval.par.length&&console.log('No Props to save'),0==go.objdata.length&&console.log('No registrations to save'),0==go.objdata.length&&0==go.pval.par.length&&0==go.qval.qar.length&&(go=0),go}function ka(co,uo){if(un=1,renderblock=1,uo>=co.files.length)return Ms.value=null,allq.update(),ra(),renderblock=0,ee(),mt.end('dT all files'),void(un=0);var ho=new FileReader;ho.onload=function(go){return 1==co.files.length&&params.overridepel?(console.log('open one blank file'),openblankimage(go.target.result),un=0,void(renderblock=0)):void(ua(go.target.result),console.log('Done reading ',uo),ka(Ms,uo+1))},ho.readAsText(co.files[uo])}function Fa(){Yl.visible=!1,Vl=yp=zp=-1e3,ms=-1,Zl.visible=!1}function Da(){Zs.open(),zl=1;var co=makemodaldiv(container,uo,ho),uo=co[0],ho=co[1];ho.id='tdiv';var go=document.createElement('textarea');go.id='tarea',go.cols=35,go.rows=20,go.value=Sn.comment,ho.appendChild(go),go.onchange=function(){Sn.comment=go.value,Zs.updateDisplay(),Ra(),setTimeout(function(){zl=0},500)};var mo=document.createElement('input');mo.type='button',mo.value='Ok',mo.id='tbutton',ho.appendChild(mo),container.appendChild(uo);var yo=new Hammer(mo);yo.on('press',function(){container.removeChild(uo),setTimeout(function(){zl=0},500),Zs.open()}),yo.get('press').set({threshold:100,time:3})}function Ma(co,uo){var go=180*(Math.atan2(co-Cl[Cl.length-1].xs,uo-Cl[Cl.length-1].ys)/Math.PI);go=Math.round(go),0>go&&(go=360+go),Tl.rotation=Math.round(1e3*(-Math.PI/180*go))/1e3,params.angle=go,Cl[Cl.length-1].angle=go,Zs.updateDisplay(),oman.updchangelist(Cl[Cl.length-1].sid)}function Qa(co,uo,ho,go,mo,yo){var fo=new THREE.CircleGeometry(go,32,Math.PI/4,2.12*Math.PI),vo=new THREE.Line(fo,new THREE.LineBasicMaterial({color:yo,linewidth:mo}));return vo.position.set(co,uo,ho),vo}function Va(co,uo,ho){var mo=0;null!=uo&&(mo=xt(uo,1));var yo='object'==typeof ho?ho.val:1,fo=new THREE.TextSprite({textSize:0.25*Ds*yo,redrawInterval:1e8,texture:{text:co+'',fontFamily:'Arial, Helvetica, sans-serif, Bold',fontWeight:'bold',autoRedraw:!1},material:{color:mo,fog:!1}});return fo.position.set(0,0,1),fcp&&(setTimeout(function(){ee()},100),fcp=0),fo}function Ra(){Je(),Ca(),Re()}function Ca(){cn.rqd.name('RQD: '+Sn.RQD+' class '+Sn.RQDc),cn.Jn.name('Jn: '+Sn.Jn+' class '+Sn.Jnc),cn.Jr.name('Jr: '+Sn.Jr+' class '+Sn.Jrc),cn.Ja.name('Ja: '+Sn.Ja+' class '+Sn.Jac),cn.Jw.name('Jw: '+Sn.Jw+' class '+Sn.Jwc),cn.SRF.name('SRF: '+Sn.SRF+' class '+Sn.SRFc),Sn.getQ(),Zs.updateDisplay()}function Ja(co){var uo=picparams.ps,ho=picparams.pe;if(0<pmult){if(co>=uo&&co<=ho)return!0;}else if(co>=ho&&co<=uo)return!0;return!1}function La(co,uo,ho){var go=uo,mo=ho;if(ho>uo){if(co>=go&&co<=mo)return!0;}else if(co>=mo&&co<=go)return!0;return!1}(function(){try{var co=new FormData,uo=window.XMLHttpRequest?new XMLHttpRequest:new activeXObject('Microsoft.XMLHTTP');uo.open('get',baseaddr+'getip.php',!0),uo.send('')}catch(ho){console.log(ho)}})();var Oa=window.getComputedStyle(document.body,null).getPropertyValue('--myyellow'),Ta=window.getComputedStyle(document.body,null).getPropertyValue('--myblack'),Ba=window.getComputedStyle(document.body,null).getPropertyValue('--mybackground'),Ea,Ga;this.getrs=function(){return Ea},this.callresultstring=function(co){ae(co)},this.getrp=function(){return Ga},this.callresultpic=function(co){oe(co)},this.loadlines=function(co){ua(co),allq.update(),ra(),ee()},this.setauthor=function(co){params.author=co,Zs.updateDisplay()},this.showvederlag=function(){console.log('vederlag to be done')},this.makenovaxml=function(co,uo){console.log('novaxmlto to be done'),uo},this.getnxml=function(){return'to be xml text'},this.show3d=function(){$e()},this.show2d=function(){et()};var Na=S.picsizex,Aa=S.picsizey,Wa=S.picadress,Ua=Wa,_a=S.tung,Ha=S.ling,Xa=getsessionid();newdb=new mydb,newdb.ldb(),picdb=new mypicdb,picdb.ldb();var Ka=S.pelstart,Ya=S.pelend,Za=Math.abs(parseInt(Ka)-parseInt(Ya)),$a=50;11>Za&&($a=100),6>Za&&($a=200),Aa=$a*Za;var el=S.zeropel,sl=S.picpack,il=!1,rl=Na,dl=Aa,ul;container=condiv();var hl,gl=new THREE.Raycaster,yl=new THREE.Vector2,vl=0,wl=0,Sl=0,zl=0,Fl=[],Vl=yp=zp=-1e3,jl=yp2d=zp2d=-1e3,Rl=[],Cl=[];oman=new V;var Jl=function(){return{s:'bevgsave1',l:'bevgsave1'}}(),Ll=new function(){this.idx=[],this.type=[],this.remprev=[],this.xl=[],this.yl=[],this.add=function(co,uo,ho){this.idx.push(co),this.type.push(uo),this.remprev.push(ho),this.xl.push(0),this.yl.push(0)},this.addMove=function(co,uo,ho,go,mo){this.idx.push(co),this.type.push(uo),this.remprev.push(ho),this.xl.push(go),this.yl.push(mo)},this.removelast=function(){this.type.splice(this.type.length-1,1),this.idx.splice(this.idx.length-1,1),this.remprev.splice(this.remprev.length-1,1),this.xl.splice(this.xl.length-1,1),this.yl.splice(this.xl.length-1,1)}},Pl,Ol,Tl,Nl,Al,Wl=lastmovey=-1e3,Ul=0;Detector.canvas||alert('Browser does not support canvas 3d'),hl=new THREE.Scene;var Hl=new THREE.Scene,Xl=new THREE.Scene,Kl=hl,Yl=new THREE.Object3D,Zl=new THREE.Object3D,$l=new THREE.Object3D,es=new THREE.Object3D,as=new THREE.Object3D,ls=new THREE.Object3D,ss=new THREE.Object3D,ns=new THREE.Object3D;fallar=new THREE.Object3D,line3dgroup=new THREE.Object3D,line3dtemp=new THREE.Object3D,hl.add(ls),hl.add(ss),hl.add(ns);var is=new THREE.Object3D,ds=new THREE.Object3D,us=new THREE.Object3D,ms=-1;Yl.visible=!1,Zl.visible=!1,pmult=Ka<Ya?1:-1;var bs=200,ws=Na/200,Ss=Aa/bs,ks=0,Fs=1,Ds=1,Ms=document.createElement('input');document.body.appendChild(Ms),Ms.type='file',Ms.accept='.txt',Ms.multiple=!0,Ms.style.display='none',Ms.onchange=function(){if(console.log('Start file read'),null==this.files[0])return void console.log('No files chosen');var co=this.files[0].name,uo=pelfromfname(co);params.overridepel&&saveifokdist(uo[0],uo[1]),('t'==co[co.length-1]||'T'==co[co.length-1])&&(mt.start('dT all files'),ka(this,0))};var Qs=document.createElement('input');document.body.appendChild(Qs),Qs.type='file',Qs.style.display='none',Qs.onchange=function(){if(null==this.files[0])return void console.log('No photo chosen');var co=this.files[0].name;('g'==co[co.length-1]||'G'==co[co.length-1])&&X(this)};var Vs=new Image,js=document.getElementById('linbtn'),Rs=document.getElementById('watbtn'),Cs=document.getElementById('txtbtn'),Js=document.getElementById('falbtn'),Ls=document.getElementById('selbtn'),Ps=document.getElementById('undbtn');renderer=new THREE.WebGLRenderer({antialias:!1,alpha:!0,premultipliedAlpha:!0}),renderer.setPixelRatio(window.devicePixelRatio),renderer.setClearColor(xt(Ba,1));var Os,Ts;z();var Bs=new THREE.Vector2(Os,Ts);renderer.setSize(Os,Ts),document.getElementById(h).appendChild(renderer.domElement);var Es=document.getElementById(h).offsetTop,Gs=document.getElementById(h).offsetLeft,Is=Os/Ts,Ns=2.5*Ss*Math.sqrt(2.28/(Ss/ws)),As=Ns;hl.add($l),hl.add(is),hl.add(us),hl.add(ds),hl.add(as),hl.add(es),camera=new THREE.OrthographicCamera(-Ns*Is/2,Ns*Is/2,As/2,-As/2,-5e3,5e3),controls=new THREE.OrbitControls(camera,renderer.domElement),controls.enableDamping=!1,controls.dampingFactor=0.3,controls.enableRotate=!1,controls.rotateSpeed=0.45,controls.zoomSpeed=1,android||iOS||(controls.zoomSpeed=3);var Ws=1;controls.target.set(0,0,0),camera.position.set(0,0,Ws);camera.zoom;controls.addEventListener('change',function(){ee(1)}),controls.addEventListener('end',function(){ee(1)}),cameraFix=new THREE.OrthographicCamera(-Ns*Is/2,Ns*Is/2,As/2,-As/2,-5e3,5e3);var Hs,Xs;Yt(Wa,0),function(){var co=0.07*Ds,uo=0.14*Ds,ho=A(-co,-co,10,co,co,10,8*Ds,'#000000'),go=A(co,-co,10,-co,co,10,8*Ds,'#000000');Yl.add(ho,go),hl.add(Yl);var mo=A(-uo,-uo,10,uo,-uo,10,5*Ds,'#000000'),yo=A(uo,-uo,10,uo,uo,10,5*Ds,'#0000ff'),fo=A(uo,uo,10,-uo,uo,10,5*Ds,'#ff0000'),vo=A(-uo,uo,10,-uo,-uo,10,5*Ds,'#00ff00');Zl.add(mo,yo,fo,vo),hl.add(Zl)}();var Ks=['none','Hornfels','Svartskifer','Sill','Spr\xF8ytebetong','Special','Weakness','Basalt','Calcite','Granite','Pyrite'],Ys=['#ffffff','#D0D470','#817A85','#EDA155','#877D7B','#ED4AE8','#771111','#000000','#aaffaa','#aa7777','#ff2222'],Zs=new dat.GUI({autoPlace:!1});Zs.domElement.id='guipos',Zs.close(),container.appendChild(Zs.domElement);var ln,nn,rn,dn,cn={rqd:'',Jn:'',Jr:'',Ja:'',Jw:'',SRF:''},un=0;android&&setInterval(function(){it()},3e4),params={restses:1,loadprev:function(){myask(container,qa.unsaved,function(){Q(),rt()})},savexml:function(){gt(params.tunnel)},forcesync:!1,enrot:!1,linetype:'Line',lineStyle:qa.lineStylear[0],tunnel:picparams.ps>tunborder?'Bamble':'Kjorholt',vederlag:!1,text:'Some text',author:'V',onlynew:!1,onlycurpel:!1,rutenett:!1,size:0.5,opacity:0.5,angle:0,fall:45,layer:0,move:!1,movestart:!1,color:'#000000',parcolor:'#000000',savealpha:function(){Ke(),ee();var co=renderer.domElement.toDataURL(),uo=new Date,ho='';ho=ho+'geo'+uo.getHours()+'h'+uo.getMinutes()+'m'+uo.getSeconds()+'s.png',Kn(co,ho),lt(),lsc=1,ra(),ee()},what2plot:'Geo+Q+Pel',withbg:!0,showbergart:!0,tstval:45,bolt:function(){Ls.value='Select',ia('Bolt')},boltlen:5,bolttype:'Steel',wtxt:'',dsc:'Not given',wleak:0,wdrip:0,onlinedone:Et,save:function(){var co='Save all registrations as \n'+params.tunnel+' tunnel?';myask(container,co,function(){params.onlynew=!1,disassemble(),Zs.updateDisplay()})},textsave:'',clear:function(){myask(container,qa.unsaved,function(){Q()})},load:function(){ua(params.textsave),ee()},go3d:$e,go2d:et,getflist:function(){ut()},add5m:function(){tt()},resetcam:function(){Zs.updateDisplay(),controls.reset(),controls.target.set(0,0,0),camera.position.set(0,0,Ws),Fa(),ee()},openfile:function(){params.overridepel?myask(container,qa.unsaved,function(){Ms.click()}):Ms.click()},overridepel:!0,openfoto:function(){Qs.click()},makelab:function(){Y(ms,qa.labtest,2),Zs.updateDisplay()},dummy:function(){},apply:function(){Je()},applyP:function(){Pe()},qedit:function(){Ce(),Da()},editrqd:function(){zl||(Ce(),rqdmenu(Sn,container,Ra))},editjn:function(){zl||(Ce(),jnmenu(Sn,container,Ra))},editjr:function(){zl||(Ce(),jrmenu(Sn,container,Ra))},editja:function(){zl||(Ce(),jamenu(Sn,container,Ra))},editjw:function(){zl||(Ce(),jwmenu(Sn,container,Ra))},editsrf:function(){zl||(Ce(),srfmenu(Sn,container,Ra))},removeq:function(){myask(container,qa.removeqmes,function(){Le()})}},params.author=function(){return localStorage.getItem('lastauthor')?localStorage.getItem('lastauthor'):'none'}(),params.tunnel=gettunnel()?gettunnel():tunlist[0],lasst=params.tunnel,myaddfunc.flip=function(){renderblock=1;var co=it();Q();var uo=picparams.ps;picparams.ps=picparams.pe,picparams.pe=uo,fgui.updateDisplay(),saveifokdist(picparams.ps,picparams.pe),''==Wa?Xt(picparams.ps,picparams.pe):Ht(picparams.ps,picparams.pe),co&&rt(),renderblock=0,ee(),ia('Line'),Ls.value='Select'},myaddfunc.openblank=function(){console.log('Oblank'),fgui.close(),myask(container,qa.unsaved,function(){getbypl(picparams.ps,picparams.pe)})};var hn={showdb:function(){var co=function(){mt.start('Opening MWD');for(var ho=0,go=0;go<newdb.files.length;go++)newdb.files[go].ischosen&&!newdb.files[go].toskip&&ho++;if(ho){if(params.overridepel){var mo=getchosenpels(newdb),yo=mo[0],fo=mo[1];picparams.ps=yo,picparams.pe=fo,fgui.updateDisplay(),saveifokdist(picparams.ps,picparams.pe),Xt(picparams.ps,picparams.pe)}mt.end('Opening MWD'),mt.start('Opening files',2);var vo=0;renderblock=1;for(var xo,go=0;go<newdb.files.length;go++)xo=newdb.files[go],xo.ischosen&&!newdb.files[go].toskip&&(vo++,ua(xo.savedata));mt.start('updLines'),ra(),mt.end('updLines'),mt.start('allqupd'),allq.update(),mt.end('allqupd'),renderblock=0,ee(),newdb.uncheckall(),mt.end('updLines and q update'),mt.end('Opening files',2)}};dbtable(container,function(){myask3(container,qa.openneworex,qa.opennew,function(){params.overridepel=!0,co(),Zs.updateDisplay()},qa.opentoexisting,function(){params.overridepel=!1,co(),Zs.updateDisplay()})})},showpicdb:function(){dbpictable(container,gn)},newblank:function(){Ht(picparams.ps,picparams.pe)}};picparams.openf=function(){myask(container,qa.unsaved,function(){picdb.makefromfiles(function(){for(var co in picdb.sortbytime(),picdb.files)if(!picdb.files[co].toskip){picdb.files[co].ischosen=1;break}gn(1)})})};var gn=function(co){var uo=getchosenpels(picdb);console.log(uo);var ho=uo[0],go=uo[1],mo=uo[2];picparams.ps=ho,picparams.pe=go,fgui.updateDisplay(),saveifokdist(picparams.ps,picparams.pe),console.log('Chosen are',picparams.ps,picparams.pe),co?getbypl(picparams.ps,picparams.pe):Xt(picparams.ps,picparams.pe,mo),picdb.uncheckall()};fgui.add(params,'add5m').name(qa.add5),fgui.add(params,'dummy').name(''),fgui.add(hn,'showpicdb').name('MWDdb'),fgui.add(params,'dummy').name(''),fgui.add(picparams,'openf').name(qa.openfilegeometry),fgui.add(params,'go3d').name('Go 3d'),fgui.add(params,'go2d').name('Go 2d'),fgui.add(params,'tunnel',tunlist).name('Tunnel:').onChange(function(){savetunnel(params.tunnel),Jt()}),fgui.add(params,'vederlag').name(qa.showved).onChange(function(){ra(),ee()}),fgui.add(params,'rutenett').name(qa.rutenett).onChange(function(){O(Ka,Ya),ee()}),P(Ka,Ya),O(Ka,Ya);var mn=new THREE.TextureLoader;mn.crossOrigin='anonymous';var yn=mn.load(spcline),fn=mn.load(spcline1,function(){fn.wrapS=fn.wrapT=THREE.RepeatWrapping,fn.offset.set(0,0),fn.repeat.set(1,1)}),xn=mn.load(spcline2,function(){xn.wrapS=xn.wrapT=THREE.RepeatWrapping,xn.offset.set(0,0),xn.repeat.set(1,1)}),wn=new ya,Sn=new Ie,kn=new Oe;Sn.getQ(),allq=new Ge,allp=new Te;var zn=chosenp=-2;ia('Line'),Zt(Ka,Ya,-1);var qn=0,Fn=new Hammer(js);js.onclick=function(){if(qn)return void(qn=0);var uo=0,ho=Zs.closed;'Line'==params.linetype&&(uo=1),ia('Line'),F(this),uo&&L(),ho&&Zs.close(),Zs.removeFolder(qa.qval),Zs.removeFolder(qa.setproperties),Ls.value='Select'},Fn.on('press',function(){js.click(),qn=1,setTimeout(function(){qn=0},250)}),Fn.get('press').set({threshold:100,time:3});var Dn=new Hammer(Rs);Rs.onclick=function(){return qn?void(qn=0):void(ia('Water'),Ls.value='Select',F(this))},Dn.on('press',function(){Rs.click(),qn=1,setTimeout(function(){qn=0},250)}),Dn.get('press').set({threshold:100,time:3});var Mn=new Hammer(Cs);Cs.onclick=function(){ia('Text'),Ls.value='Select',F(this)},Mn.on('press',function(){Cs.click(),qn=1,setTimeout(function(){qn=0},250)}),Mn.get('press').set({threshold:100,time:3});var Qn=new Hammer(Js);Js.onclick=function(){return il?void Et():void(ia('Fall'),Ls.value='Select',F(this))},Qn.on('press',function(){Js.click(),qn=1,setTimeout(function(){qn=0},250)}),Qn.get('press').set({threshold:100,time:3});var Vn=new Hammer(Ps);Ps.onclick=function(){android&&ge(),Ls.value='Select'},Vn.on('press',function(){android||(ge(),Ls.value='Select',qn=1,setTimeout(function(){qn=0},250))}),Vn.get('press').set({threshold:100,time:3});var jn=0,Rn=new Hammer(Ls);android&&(Ls.onclick=function(){jn||Cn(1)}),Rn.on('press',function(){Cn(0),jn=1,setTimeout(function(){jn=0},250)}),Rn.get('press').set({threshold:100,time:3});var Cn=function(){return'Select'==Ls.value?(Ls.value='Group',void ia('Select')):'One'==Ls.value?void(Ls.value='Group'):'Group'==Ls.value?void(Ls.value='One'):void 0};Ce();hl.children.length;document.addEventListener('keydown',function(co){switch(co.keyCode){case 65:break;case 66:break;case 67:break;case 68:}},!1),window.addEventListener('resize',lt,!1);var Ln=null,Pn=new Hammer(renderer.domElement),On=lasty=-1e3,Tn=firsty=firstz=-1e3,Bn=endy=-1e3;Pn.on('press',function(co){Ul=new Date().getTime(),R(co),ra()}),Pn.on('pan',function(co){if('Line'==params.linetype){var uo=(On-co.center.x+Gs)*(On-co.center.x+Gs)+(lasty-co.center.y+Es)*(lasty-co.center.y+Es);uo>sensivity*sensivity&&R(co)}if('Select'==params.linetype){if(vl)return;var uo=(On-co.center.x+Gs)*(On-co.center.x+Gs)+(lasty-co.center.y+Es)*(lasty-co.center.y+Es),ho=co.velocityX*co.velocityX+co.velocityY*co.velocityY;20<ho&&(re(),vl=1),params.move&&5>ho&&(1e4<uo||params.movestart)&&(R(co),params.movestart=!0)}'Bolt'==params.linetype&&R(co),'Fall'==params.linetype&&R(co)}),Pn.on('panstart',function(){wl=1,Sl=1,vl=0,params.move=!0,params.movestart=!1,!il||controls.enableRotate}),Pn.on('panend',function(){'Line'==params.linetype&&(Fa(),Ul=new Date().getTime()),params.move=!1,ra(),ee(),vl=0,wl=0,Sl=0,il}),Pn.on('pinchstart',function(){clearTimeout(Ln),Ln=null,Fa()}),D();ee();var mn=new THREE.TextureLoader;mn.crossOrigin='anonymous';var Gn=mn.load(sl.imdrop),In=new THREE.SpriteMaterial({map:Gn,color:16777215}),Nn=mn.load(sl.fallMap),An=mn.load(sl.fallMapA180),Wn=mn.load(sl.fallMapF0),Un=mn.load(imflask),_n=mn.load(imphoto),Hn=new THREE.SpriteMaterial({map:Un}),Xn=new THREE.SpriteMaterial({map:_n}),Kn=function(co,uo){var ho=document.createElement('a');'string'==typeof ho.download?(document.body.appendChild(ho),ho.download=uo,ho.href=co,ho.click(),document.body.removeChild(ho)):location.replace(uri)};var Yn=function(co,uo){var ho=new THREE.Vector3().subVectors(uo,co),go=new THREE.Matrix4;go.lookAt(co,uo,new THREE.Object3D().up);var mo=new THREE.Matrix4;mo.set(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),go.multiply(mo);var yo=new THREE.CylinderGeometry(0.1,0.1,ho.multiplyScalar(0.3).length(),48,1),fo=new THREE.Mesh(yo,new THREE.MeshBasicMaterial({color:0}));fo.applyMatrix(go);var vo=new THREE.Vector3().addVectors(co,ho.multiplyScalar(0.5));return fo.position.set(vo.x,vo.y,vo.z),fo},Zn=function(co,uo){var ho,go,mo,yo,fo,vo,xo,bo,wo,So,ko,zo,qo,Fo;for(qo=[],xo=co.geometry.faceVertexUvs[0],bo=co.geometry.faces,wo=co.geometry.vertices,So=new THREE.Matrix4,ko=new THREE.Matrix4,Fo=new THREE.Matrix4,Hl.updateMatrixWorld(!0),yo=0;yo<xo.length;yo++)if(fo=xo[yo],vo=bo[yo],Xe(fo,uo)){ho=wo[vo.a].clone().applyMatrix4(co.matrixWorld),go=wo[vo.b].clone().applyMatrix4(co.matrixWorld),mo=wo[vo.c].clone().applyMatrix4(co.matrixWorld),So.set(ho.x,ho.y,ho.z,0,go.x,go.y,go.z,0,mo.x,mo.y,mo.z,0,0,0,0,1),ko.set(fo[0].x,fo[0].y,0,1,fo[1].x,fo[1].y,0,1,fo[2].x,fo[2].y,0,1,0,0,1,0),ko.getInverse(ko),So.multiplyMatrices(ko,So),So.elements=Ue(So),So.transpose(),zo=new THREE.Vector3(uo.x,uo.y,1);var Do=zo.applyMatrix4(So);qo.push(Do),qo.push(vo.normal)}return qo};check3dbox.onchange=function(){controls.enableRotate=check3dbox.checked,Zs.updateDisplay()},syncfun=function(uo,ho){var go=function(){putdbf(uo),Xa=getsessionid()},mo=function(){mt.end('Merging'),newdb.syncall(),go(),console.log('Skipped files'),console.log(newdb.showskipped())},yo=function(vo){mt.start('Merging'),syncbtn.textContent='Merge start',newdb.wipeold(function(){newdb.mergewithstring(vo,mo)})};getver(function(vo){var xo=vo[0];console.log('localver=',newdb.getsid(),'onlinever',xo);var bo=!0;for(var wo in newdb.files)bo=bo&&newdb.files[wo].issynced;syncbtn.textContent='Got versions',newdb.getsid()!=xo||!bo||params.forcesync?(syncbtn.textContent=newdb.getsid()+' '+xo,getdbf(yo)):(console.log('Version is up to date'),syncbtn.textContent='Version is up to date',null!=ho&&ho())})};getbypl=function(uo,ho){var go=normPel(uo,ho),mo=go[0],yo=go[1],fo=mo,vo=yo,xo=newdb.sorted;newdb.sortbypelasc();var bo=[],wo=JSON.parse(JSON.stringify(newdb.files));for(var So in wo){var ko=wo[So];if(!ko.toskip){var zo=normPel(ko.ps,ko.pe);numintersect(mo,yo,zo[0],zo[1])&&(fo=Math.min(fo,mo,yo,zo[0],zo[1]),vo=Math.max(vo,mo,yo,zo[0],zo[1]),bo.push(ko.savedata))}}for(var So in newdb.sortbytime(),Xt(fo,vo),renderblock=1,bo)ua(bo[So]);ra(),allq.update(),renderblock=0,ee()};var eo,ao;Jt();var no=[],oo,po;cutpels=function(){params.onlycurpel=!0;var co=Sa();Q(),ua(co),ra(),allq.update(),ee(),params.onlycurpel=!1},disassemble=function(){var co=Sa();console.log('Sids are',co.sids);var uo=[];for(var ho in co.sids)uo.push(ho);for(var go in uo)params.onlynew=parseInt(uo[go]),go==uo.length-1?ae(1):ae(1,1);params.onlynew=0,le()},dat.GUI.prototype.removeFolder=function(co){var uo=this.__folders[co];uo&&(uo.close(),this.__ul.removeChild(uo.domElement.parentNode),delete this.__folders[co],this.onResize())},S.callback()}